import{a as Q}from"./chunk-BZ6WFO4I.js";import{Ac as di,Ad as q,Dc as mi,He as J,I as hi,Ie as Ri,K as ui,Ld as p,Md as v,N as zi,Qd as g,Rd as R,Sd as S,T as k,Td as M,Ua as fi,Ud as m,Vd as F,Wd as ci,Xd as N,Yd as Y,Zd as yi,_ as K,_c as L,a as ai,ad as gi,ae as oi,b as li,ba as W,ce as O,da as D,dd as vi,de as X,ed as B,ee as Ii,gd as bi,ha as w,j,jd as H,kd as E,la as b,lf as P,m as G,pd as ni,u as ri,uc as Si,we as A,x as U,y as C,yd as x}from"./chunk-JM7E5TVI.js";function V(f){Object.keys(f).filter(Z=>f[Z]===void 0).forEach(Z=>delete f[Z])}function pi(f){let Z=new Map;return i=>{let t=Z.get(i);return t!=null||(t=f(i),Z.set(i,t)),t}}var ii=(()=>{class f{base64codes=new Uint8Array(256).fill(255);constructor(){for(let i=0;i<N.length;i++)this.base64codes[N.charCodeAt(i)]=i;this.base64codes[95]=0}nToId=pi(i=>i/Y>=1?this.nToId(Math.floor(i/Y))+this.nToId(i%Y):N[i]);idToN=pi(i=>{let t=yi[i[0]];return i.length>1?(i=i.substring(1),t*Math.pow(Y,i.length)+this.idToN(i)):t});deflate(i){return j(this,null,function*(){let t=yield this.compress(i,"deflate");return this.bytesToBase64(t)})}inflate(i){return j(this,null,function*(){try{return yield this.inflateStr(i)}catch{console.warn("Router failed to parse url, checking for missing trailing characters...")}try{return yield this.inflateMend(i,"-")}catch{}try{return yield this.inflateMend(i,".")}catch{}return yield this.inflateMend(i,"_")})}inflateMend(i,t){return j(this,null,function*(){let r=yield this.inflateStr(i+t);if(!r)throw new Error("Failed to parse, generated empty string");return console.warn(`Router mended url by appending '${t}'`),r})}inflateStr(i){return this.decompress(this.base64ToBytes(i))}bytesToBase64(i){let t="",r,e=i.length;for(r=2;r<e;r+=3)t+=N[i[r-2]>>2],t+=N[(i[r-2]&3)<<4|i[r-1]>>4],t+=N[(i[r-1]&15)<<2|i[r]>>6],t+=N[i[r]&63];return r===e+1&&(t+=N[i[r-2]>>2],t+=N[(i[r-2]&3)<<4],t+="__"),r===e&&(t+=N[i[r-2]>>2],t+=N[(i[r-2]&3)<<4|i[r-1]>>4],t+=N[(i[r-1]&15)<<2],t+="_"),t}getBase64Code(i){if(i>=this.base64codes.length)throw new Error("Unable to parse base64 string.");let t=this.base64codes[i];if(t===255)throw new Error("Unable to parse base64 string.");return t}base64ToBytes(i){if(i.length%4!==0)throw new Error("Unable to parse base64 string.");let t=i.indexOf("_");if(t!==-1&&t<i.length-2)throw new Error("Unable to parse base64 string.");let r=i.endsWith("__")?2:i.endsWith("_")?1:0,e=i.length,s=new Uint8Array(3*(e/4)),n;for(let c=0,o=0;c<e;c+=4,o+=3)n=this.getBase64Code(i.charCodeAt(c))<<18|this.getBase64Code(i.charCodeAt(c+1))<<12|this.getBase64Code(i.charCodeAt(c+2))<<6|this.getBase64Code(i.charCodeAt(c+3)),s[o]=n>>16,s[o+1]=n>>8&255,s[o+2]=n&255;return s.subarray(0,s.length-r)}compress(i,t="deflate"){return j(this,null,function*(){let r=new TextEncoder().encode(i),e=new CompressionStream(t),s=e.writable.getWriter();s.write(r),s.close();let n=new Response(e.readable).arrayBuffer();return new Uint8Array(yield n)})}decompress(i,t="deflate"){return j(this,null,function*(){let r=new DecompressionStream(t),e=r.writable.getWriter();e.write(i).catch(()=>{}),e.close().catch(()=>{});let s=new Response(r.readable).arrayBuffer();return new TextDecoder().decode(yield s)})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();var Ti=(()=>{class f{http=b(Si);store=b(L);translateSvc=b(P);cacheData={};cacheHash={};cacheI18n={};initialize(){C([this.store.select(A.selectModId),this.translateSvc.lang$]).subscribe(([i])=>{this.requestData(i).subscribe()})}requestData(i){let t,r,e;this.cacheData[i]||(this.cacheData[i]=this.http.get(`data/${i}/data.json`).pipe(D(a=>t=a),K()));let s=this.cacheData[i];this.cacheHash[i]||(this.cacheHash[i]=this.http.get(`data/${i}/hash.json`).pipe(D(a=>r=a),K()));let n=this.cacheHash[i],c=this.translateSvc.currentLang,o=`${i}-${c}`,l=c==="en",h;return l?h=ri(null):(this.cacheI18n[o]||(this.cacheI18n[o]=this.http.get(`data/${i}/i18n/${c}.json`).pipe(ui(()=>(console.warn(`No localization file found for ${o}`),ri(null))),D(a=>e=a??void 0),K())),h=this.cacheI18n[o]),C([s,n,h]).pipe(D(()=>{(t||r||e)&&this.store.dispatch(X.loadMod({id:i,i18nId:o,data:t,hash:r,i18n:e}))}))}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();var Mi=(()=>{class f{event(i,t){gi.production&&gtag("event",i,{event_category:t})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();var ti=(()=>{class f{compressionSvc=b(ii);zipList(i){return{bare:encodeURIComponent(i.map(t=>t.bare).join(S)),hash:i.map(t=>t.hash).join(S)}}zipFields(i){return i.join(m).replace(/\**$/,"")}zipTruthyString(i){return i??""}zipTruthyNumber(i){return i==null?"":i.toString()}zipTruthyBool(i){return i==null?"":i?F:ci}zipTruthyArray(i){return i==null?"":i.length?i.join(M):R}zipTruthyNString(i,t){return i==null?"":this.compressionSvc.nToId(t.indexOf(i))}zipTruthyNArray(i,t){return i==null?"":i.length?i.map(r=>this.compressionSvc.nToId(t.indexOf(r))).join(M):R}zipDiffString(i,t){return i===t?"":i??g}zipDiffNumber(i,t){return i===t?"":i==null?g:i.toString()}zipDiffNRational(i,t){return this.zipDiffNNumber(i?.toNumber(),t?.toNumber())}zipDiffRational(i,t){return(i==null?t==null:t!=null&&i.eq(t))?"":i==null?g:i.toString()}zipDiffDisplayRate(i,t){if(i===t)return"";switch(i){case E.PerSecond:return"0";case E.PerMinute:return"1";case E.PerHour:return"2";default:return g}}zipDiffBool(i,t){return i===t?"":i==null?g:i?F:ci}zipDiffNullableArray(i,t){let r=i!=null?i.length>0?[...i].sort().join(M):R:g,e=t!=null?t.length>0?[...t].sort().join(M):R:g;return r===e?"":r}zipDiffNString(i,t,r){return i===t?"":i==null?g:this.compressionSvc.nToId(r.indexOf(i))}zipDiffNNumber(i,t){return i===t?"":i==null?g:this.compressionSvc.nToId(i)}zipDiffNullableNArray(i,t,r){let e=i!=null?i.length>0?i.map(n=>this.compressionSvc.nToId(r.indexOf(n))).sort().join(M):R:g,s=t!=null?t.length>0?t.map(n=>this.compressionSvc.nToId(r.indexOf(n))).sort().join(M):R:g;return e===s?"":e}parseString(i,t){if(t!=null)return this.parseNString(i,t);if(!(!i?.length||i===g))return i}parseBool(i){if(!(!i?.length||i===g))return i===F}parseNumber(i,t=!1){if(t)return this.parseNNumber(i);if(!(!i?.length||i===g))return Number(i)}parseRational(i,t=!1){if(t)return H(this.parseNNumber(i));if(!(!i?.length||i===g))return H(i)}parseDisplayRate(i){if(!(!i?.length||i===g))switch(i){case"0":return E.PerSecond;case"1":return E.PerMinute;case"2":return E.PerHour;default:return}}parseArray(i,t){if(t)return this.parseNArray(i,t);if(!(!i?.length||i===g))return i===R?[]:i.split(M)}parseNullableArray(i,t){if(t)return this.parseNullableNArray(i,t);if(i?.length)return i===g?null:i===R?[]:i.split(M)}parseNString(i,t){let r=this.parseString(i);return r==null?r:t[this.compressionSvc.idToN(r)]}parseNNumber(i){if(!(!i?.length||i===g))return this.compressionSvc.idToN(i)}parseNArray(i,t){let r=this.parseArray(i);return r==null?r:r.map(e=>t[this.compressionSvc.idToN(e)])}parseNullableNArray(i,t){let r=this.parseNullableArray(i);return r==null?r:r.map(e=>t[this.compressionSvc.idToN(e)])}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();var ei=function(f){return f.ExpensiveDeprecation="The expensive setting has been removed. Please use or request an expensive data set instead.",f.LimitStepDeprecation="Limit steps have been replaced by limit objectives. Results may differ if using multiple objectives as limits apply to all objectives.",f}(ei||{}),Ni=(()=>{class f{store=b(L);analyticsSvc=b(Mi);contentSvc=b(Q);translateSvc=b(P);zipSvc=b(ti);fixV8ExcludedRecipes$=new G;constructor(){this.fixV8ExcludedRecipes$.pipe(W(()=>this.store.select(A.selectMod).pipe(U(i=>i?.defaults),bi(),k())),W(()=>C({recipesRaw:this.store.select(J.recipesState),recipesState:this.store.select(J.selectRecipesState)}).pipe(k())),D(({recipesRaw:i,recipesState:t})=>{let r=[];for(let e of Object.keys(t))t[e].excluded&&!i[e]?.excluded&&r.push({id:e,value:!1,def:!0});this.store.dispatch(J.setExcludedBatch({values:r}))})).subscribe()}migrate(i,t){let r=i[p.Version]??v.Version0;this.analyticsSvc.event("unzip_version",r),(t||r===v.Version0)&&Object.keys(i).forEach(s=>{i[s]=decodeURIComponent(i[s])});let e=this.migrateAny(i,t,r);return this.displayWarnings(e.warnings),e}migrateAny(i,t,r){let e=[],s={params:i,warnings:e,isBare:t};switch(r){case v.Version0:return this.migrateV0(s);case v.Version1:return this.migrateV1(s);case v.Version2:return this.migrateV2(s);case v.Version3:return this.migrateV3(s);case v.Version4:return this.migrateV4(s);case v.Version5:return this.migrateV5(s);case v.Version6:return this.migrateV6(s);case v.Version7:return this.migrateV7(s);case v.Version8:return this.migrateV8(s);case v.Version9:return this.migrateV9(s);default:return{params:i,warnings:e,isBare:t}}}migrateV0(i){let{params:t}=i;if(t[p.Settings]){let e=t[p.Settings].split(m),s=this.zipSvc.parseString(e[0]);s=s&&O.modHash[O.modHashV0.indexOf(s)],s=s??g;let n=this.zipSvc.parseNumber(e[6])??A.initialState.displayRate,c=this.zipSvc.zipDiffDisplayRate(n,A.initialState.displayRate);t[p.Settings]=this.zipSvc.zipFields([s,c,t[p.Mod],e[1],e[3],e[4],e[5],e[7],e[8],e[10],e[9],e[2],e[11],e[12]])}else t[p.Mod]&&(t[p.Settings]=this.zipSvc.zipFields([g,g,t[p.Mod]]));return t[p.Version]=v.Version1,this.migrateV1(i)}migrateV1(i){let{params:t,warnings:r}=i;if(t[p.Settings]){let s=t[p.Settings].split(m),n=11;if(s.length>n){let c=s.splice(n,1);this.zipSvc.parseBool(c[0])&&r.push(ei.ExpensiveDeprecation)}t[p.Settings]=this.zipSvc.zipFields(s)}return t[p.Version]=v.Version4,this.migrateV4(i)}migrateV2(i){let{params:t}=i;if(t[p.Recipes]){let e=t[p.Recipes].split(S),s=[],n=3;for(let c of e){let o=c.split(m);if(o.length>n){let l=this.zipSvc.parseNNumber(o[n])?.toString();o[n]=this.zipSvc.zipTruthyString(l)}s.push(this.zipSvc.zipFields(o))}t[p.Recipes]=s.join(S)}if(t[p.Machines]){let e=t[p.Machines].split(S),s=[],n=2;for(let c of e){let o=c.split(m);if(o.length>n){let l=this.zipSvc.parseNNumber(o[n])?.toString();o[n]=this.zipSvc.zipTruthyString(l)}s.push(this.zipSvc.zipFields(o))}t[p.Machines]=s.join(S)}return t[p.Version]=v.Version3,this.migrateV3(i)}migrateV3(i){let{params:t,warnings:r}=i;if(t[p.Settings]){let s=t[p.Settings].split(m),n=10;if(s.length>n){let c=s.splice(n,1);this.zipSvc.parseBool(c[0])&&r.push(ei.ExpensiveDeprecation)}t[p.Settings]=this.zipSvc.zipFields(s)}return t[p.Version]=v.Version5,this.migrateV5(i)}migrateInlineBeaconsSection(i,t,r,e){if(i[t]){let n=i[t].split(S),c=[];for(let o of n.map(l=>l.split(m))){let l=r+1,h=l+1,a=h+3;if(o.length>r){let u,z,d;o.length>a&&(d=o.splice(a,1)[0]),o.length>h&&(u=o.splice(h,1)[0]),o.length>l&&(z=o.splice(l,1)[0]);let y=o[r];o[r]=this.zipSvc.zipTruthyArray([e.length]),e.push(this.zipSvc.zipFields([y,this.zipSvc.zipTruthyString(z),this.zipSvc.zipTruthyString(u),this.zipSvc.zipTruthyString(d)]))}c.push(this.zipSvc.zipFields(o))}i[t]=c.join(S)}}migrateInlineBeacons(i){let t=[];return this.migrateInlineBeaconsSection(i.params,p.RecipeObjectives,4,t),this.migrateInlineBeaconsSection(i.params,p.Recipes,3,t),t.length&&(i.params[p.Beacons]=t.join(S)),i}migrateV4(i){return i=this.migrateInlineBeacons(i),i.params[p.Version]=v.Version6,this.migrateV6(i)}migrateV5(i){return i=this.migrateInlineBeacons(i),i.params[p.Version]=v.Version7,this.migrateV7(i)}migrateInsertField(i,t,r){if(i[t]){let e=i[t].split(S);for(let s=0;s<e.length;s++){let n=e[s].split(m);n.length>r&&(n.splice(r,0,""),e[s]=this.zipSvc.zipFields(n))}i[t]=e.join(S)}}migrateDeleteField(i,t,r){if(i[t]){let e=i[t].split(S);for(let s=0;s<e.length;s++){let n=e[s].split(m);n.length>r&&(n.splice(r,1),e[s]=this.zipSvc.zipFields(n))}i[t]=e.join(S)}}migrateMoveUpField(i,t,r){if(i[t]!=null){let e=i[t];for(i.splice(t,1),i.length>r&&i.splice(r,0,"");i.length<=r;)i.push("");i[r]=e}}migrateToV8(i){let{params:t,isBare:r}=i,e=!1;if(this.migrateInsertField(t,p.RecipeObjectives,2),t[p.Objectives]){let s=t[p.Objectives].split(S),n=[...s];for(let c=0;c<s.length;c++){let l=s[c].split(m);if(l[2]==="3")if(r){let h=t[p.RecipeObjectives]?t[p.RecipeObjectives].split(S):[];if(l.length>3){let a=[l[3],l[1],x.Limit.toString()],u=[l[0],"1",x.Maximize.toString()];h.push(this.zipSvc.zipFields(u)),h.push(this.zipSvc.zipFields(a)),e=!0}else h.push(this.zipSvc.zipFields([l[0],l[1]]));n.splice(c,1),t[p.RecipeObjectives]=h.join(S)}else l[2]="0",n[c]=this.zipSvc.zipFields(l);else if(l.length>3){let h=[l[3],l[1],l[2],x.Limit.toString()],a=[l[0],"1","",x.Maximize.toString()];n[c]=this.zipSvc.zipFields(a),n.push(this.zipSvc.zipFields(h)),e=!0}}e&&i.warnings.push(ei.LimitStepDeprecation),t[p.Objectives]=n.join(S)}if(this.migrateDeleteField(t,p.Items,4),this.migrateInsertField(t,p.Recipes,1),t[p.Settings]){let s=t[p.Settings].split(m),n=r?1:0;if(s.length>2+n){let c=this.zipSvc.parseArray(s[2+n]);if(c){let o=t[p.Recipes],l=o?o.split(S):[];for(let h of c){let a=!1;for(let u=0;u<l.length;u++){let z=l[u].split(m);z[0]===h&&(a=!0,z[1]=F,l[u]=this.zipSvc.zipFields(z))}a||l.push(this.zipSvc.zipFields([h,F]))}t[p.Recipes]=l.join(S),this.fixV8ExcludedRecipes$.next()}s.splice(2+n,1)}s.splice(n,0,""),this.migrateMoveUpField(s,16+n,20+n),this.migrateMoveUpField(s,15+n,19+n),this.migrateMoveUpField(s,14+n,18+n),this.migrateMoveUpField(s,13+n,17+n),t[p.Settings]=this.zipSvc.zipFields(s)}return t[p.Version]=v.Version8,i}migrateV6(i){return i.isBare=!0,this.migrateV8(this.migrateToV8(i))}migrateV7(i){return i.isBare=!1,this.migrateV8(this.migrateToV8(i))}migrateV8(i){let{params:t}=i;if(t[p.RecipeObjectives]){let r=[];t[p.Objectives]&&(r=t[p.Objectives].split(S));let e=t[p.RecipeObjectives].split(S);for(let s=0;s<e.length;s++){let n=e[s].split(m),c=this.zipSvc.zipFields([n[0],n[1],"3",n[2],n[3],n[4],n[5],n[6],n[7]]);r.push(c)}t[p.RecipeObjectives]="",t[p.Objectives]=r.join(S)}return this.migrateV9(i)}migrateInlineModulesSection(i,t,r,e){if(i[t]){let n=i[t].split(S),c=[];for(let o of n.map(l=>l.split(m))){if(o.length>r){let l=o[r],h=this.zipSvc.parseArray(l);if(h==null)continue;let a=new Map;for(let z of h){let d=a.get(z)??0;a.set(z,d+1)}let u=Array.from(a.keys()).map((z,d)=>e.length+d);o[r]=this.zipSvc.zipTruthyArray(u);for(let z of a.keys())e.push(this.zipSvc.zipFields([B(a.get(z)?.toString(),""),z]))}c.push(this.zipSvc.zipFields(o))}i[t]=c.join(S)}}migrateV9(i){let{params:t}=i,r=[];if(this.migrateInlineModulesSection(i.params,p.Beacons,1,r),this.migrateInlineModulesSection(i.params,p.Recipes,3,r),this.migrateInlineModulesSection(i.params,p.Objectives,5,r),i.params[p.Machines]){let s=t[p.Machines].split(S),n=[],c=i.params[p.Beacons]?i.params[p.Beacons].split(S):[],o=2,l=o+1,h=l+1;s.map(a=>a.split(m)).forEach((a,u)=>{if(u===0&&a[0]===F&&(a[0]=R),this.migrateMoveUpField(a,5,6),a[0]!==R&&a[0]!==""&&a.length>1){let z=a[1];if(z){let d=z.split(M)[0];a[1]=this.zipSvc.zipTruthyArray([r.length]),r.push(this.zipSvc.zipFields(["",d]))}}if(a.length>2){let z,d;if(a.length>h&&(z=a.splice(h,1)[0]),a.length>l){let T=a.splice(l,1)[0];if(T){let I=T.split(M)[0];d=[r.length],r.push(this.zipSvc.zipFields(["",I]))}}let y=a[o];a[o]=this.zipSvc.zipTruthyArray([c.length]),c.push(this.zipSvc.zipFields([y,this.zipSvc.zipTruthyArray(d),this.zipSvc.zipTruthyString(z)]))}n.push(this.zipSvc.zipFields(a))}),c.length&&(i.params[p.Beacons]=c.join(S)),i.params[p.Machines]=n.join(S)}if(r.length&&(i.params[p.Modules]=r.join(S)),t[p.Settings]){let e=t[p.Settings].split(m),s=i.isBare?5:4;if(e.length>s){let n=e.splice(s,1)[0];if(t[p.Machines]){let c=t[p.Machines].split(S).map(l=>l.split(m)),o=c.find(l=>l[0]===R||l[0]==="");if(o){for(;o.length<4;)o.push("");o[3]=n}else c.unshift(["","","",n]);t[p.Machines]=c.map(l=>this.zipSvc.zipFields(l)).join(S)}else t[p.Machines]=["","","",n].join(m);t[p.Settings]=e.join(m)}}return t[p.Version]=v.Version10,i}displayWarnings(i){this.translateSvc.multi(["app.migrationWarning","OK"]).pipe(k()).subscribe(([t,r])=>{for(let e of i)this.contentSvc.confirm({message:e,header:t,acceptLabel:r,rejectVisible:!1})})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();var Mt=(()=>{class f{router=b(mi);store=b(L);translateSvc=b(P);contentSvc=b(Q);dataSvc=b(Ti);compressionSvc=b(ii);zipSvc=b(ti);migrationSvc=b(Ni);zip;zipConfig=fi(this.empty);version=v.Version10;zipTail={bare:`&${p.Version}=${this.version}`,hash:`&${p.Version}${this.version}`};first=!0;ready$=new G;get empty(){return{bare:"",hash:""}}get emptyRecipeSettingsInfo(){return{idMap:{},list:[]}}get emptyMachineSettings(){return{moduleMap:{},beaconMap:{}}}initialize(){this.router.events.subscribe(i=>this.updateState(i)),this.ready$.pipe(k(),D(()=>this.dataSvc.initialize()),W(()=>this.store.select(Ri.selectZipState)),zi(0),D(i=>this.updateUrl(i.objectives,i.itemsState,i.recipesState,i.machinesState,i.settings))).subscribe()}getModIdFromState(i){return j(this,null,function*(){if(i.startsWith("z=")){let t=i.match("z=(.+?)(&|$)");if(t==null)return;let r=t[1],s=(yield this.compressionSvc.inflate(r)).match("(&|^)b(.*?)(&|$)");if(s==null)return;let n=s[2];return this.zipSvc.parseNString(n,O.modHash)}else{let t=i.match("s=(.+?)(&|$)");return t?.[1]}})}getGameFromModId(i){return i==null?ni.Factorio:O.mods.find(t=>t.id===i)?.game??ni.Factorio}updateUrl(i,t,r,e,s){this.zipState(i,t,r,e,s).subscribe(n=>j(this,null,function*(){this.zip=yield this.getHash(n);let c=this.router.url.split("#"),o=`${c[0].split("?")[0]}?${this.zip}${c[1]&&`#${c[1]}`||""}`;this.router.navigateByUrl(o),!o.startsWith("/?")&&!o.startsWith("/wizard")&&(Ii.routerState=o)}))}zipState(i,t,r,e,s){return this.store.select(X.selectHash).pipe(U(n=>n[s.modId]),hi(n=>n!=null),k(),U(n=>{let c=this.zipModulesBeacons(i,r,e,n),o=Object.keys(i.entities).map(h=>i.entities[h]);this.zipObjectives(c,o,n);let l=this.zipSvc.zipDiffString(s.modId,A.initialState.modId);return l.length&&(c.config.hash+=`&${p.Mod}${this.compressionSvc.nToId(O.modHash.indexOf(l))}`),this.zipItems(c,t,n),this.zipRecipes(c,r,n),this.zipMachines(c,e,n),this.zipSettings(c,s,n),this.zipConfig.set(c.config),c}))}stepHref(i,t,r){return j(this,null,function*(){if(r==null)return null;let e;if(i.itemId!=null&&i.items!=null?e=[{id:"0",targetId:i.itemId,value:i.items,unit:q.Items,type:x.Output}]:i.recipeId!=null&&i.machines!=null&&(e=[{id:"0",targetId:i.recipeId,value:i.machines,unit:q.Machines,type:x.Output}]),e==null)return null;let s={objectives:this.empty,config:t,objectiveSettings:this.emptyMachineSettings,recipeSettings:this.emptyMachineSettings,machineSettings:this.emptyMachineSettings};return this.zipObjectives(s,e,r),`list?${yield this.getHash(s)}`})}getHash(i){return j(this,null,function*(){let t=i.objectives.bare+i.config.bare+this.zipTail.bare;t.startsWith("&")&&(t=t.substring(1));let r=i.objectives.hash+i.config.hash+this.zipTail.hash,s=`z=${yield this.compressionSvc.deflate(r)}&${p.Version}=${this.version}`;return t.length<Math.max(s.length,100)?t:s})}getParams(i){let t=i.split("&"),r=t[0][1]==="="?2:1;return t.reduce((s,n)=>(s[n[0]]=n.substring(r),s),{})}updateState(i){return j(this,null,function*(){try{if(i instanceof di){let[t,...r]=i.urlAfterRedirects.split("#"),e=r.join("#"),[s,...n]=t.split("?"),c=n.join("?");if(!c.length&&e.length>1&&e[1]==="="&&(c=e),c&&this.zip!==c){let o=c,l=!0,h=new URLSearchParams(o).get(p.Zip);if(h!=null){let z=h.replace(/\+/g,"-").replace(/\//g,".").replace(/=/g,"_");o=yield this.compressionSvc.inflate(z),l=!1}o=o.replace(/,/g,S).replace(/\+/g,M),o=o.replace(/\*n\*/g,`*${g}*`).replace(/\*e\*/g,`*${R}*`);let a=this.getParams(o);({params:a,isBare:l}=this.migrationSvc.migrate(a,l));let u={};if(l){let z=this.unzipModules(a),d=this.unzipBeacons(a,z);a[p.Objectives]&&(u.objectivesState=this.unzipObjectives(a,z,d)),a[p.Items]&&(u.itemsState=this.unzipItems(a)),a[p.Recipes]&&(u.recipesState=this.unzipRecipes(a,z,d)),a[p.Machines]&&(u.machinesState=this.unzipMachines(a,z,d)),a[p.Settings]&&(u.settingsState=this.unzipSettings(a)),this.dispatch(o,u)}else{let z=this.zipSvc.parseNString(a[p.Mod],O.modHash);this.dataSvc.requestData(z||A.initialState.modId).subscribe(([d,y])=>{let T=this.unzipModules(a,y),I=this.unzipBeacons(a,T,y);a[p.Objectives]&&(u.objectivesState=this.unzipObjectives(a,T,I,y)),a[p.Items]&&(u.itemsState=this.unzipItems(a,y)),a[p.Recipes]&&(u.recipesState=this.unzipRecipes(a,T,I,y)),a[p.Machines]&&(u.machinesState=this.unzipMachines(a,T,I,y)),a[p.Settings]&&(u.settingsState=this.unzipSettings(a,y)),z!=null&&(u.settingsState=li(ai({},u.settingsState),{modId:z})),this.dispatch(o,u)})}}else this.ready$.next()}}catch(t){throw console.error(t),new Error("RouterService failed to parse url")}})}dispatch(i,t){this.zip=i,this.store.dispatch(vi.load({partial:t})),this.ready$.next()}zipModulesBeacons(i,t,r,e){let s=this.emptyRecipeSettingsInfo,n=this.emptyRecipeSettingsInfo,c=this.zipMachineSettings(i.entities,s,n,e),o=this.zipMachineSettings(t,s,n,e),l=this.zipMachineSettings(r.entities,s,n,e);if(r.beacons){let u=this.beaconModuleMap(r.beacons,s,e);l.beaconMap[""]=this.zipBeaconArray(r.beacons,u,n,e)}let h=this.empty;return[[p.Modules,s.list],[p.Beacons,n.list]].forEach(([u,z])=>{let d=this.zipSvc.zipList(z);d.bare.length&&(h.bare+=`&${u}=${d.bare}`,h.hash+=`&${u}${d.hash}`)}),{objectives:this.empty,config:h,objectiveSettings:c,recipeSettings:o,machineSettings:l}}zipMachineSettings(i,t,r,e){let s=this.emptyMachineSettings;for(let n of Object.keys(i)){let c=i[n];if(c.modules!=null&&(s.moduleMap[n]=this.zipModuleArray(c.modules,t,e)),c.beacons!=null){let o=this.beaconModuleMap(c.beacons,t,e);s.beaconMap[n]=this.zipBeaconArray(c.beacons,o,r,e)}}return s}beaconModuleMap(i,t,r){return i.map(e=>{if(e.modules!=null)return this.zipModuleArray(e.modules,t,r)})}zipModuleArray(i,t,r){return i.map(e=>{let s=this.zipSvc.zipTruthyString(e.count?.toString()),n={bare:this.zipSvc.zipFields([s,this.zipSvc.zipTruthyString(e.id)]),hash:this.zipSvc.zipFields([s,this.zipSvc.zipTruthyNString(e.id,r.modules)])};return t.idMap[n.bare]==null&&(t.idMap[n.bare]=t.list.length,t.list.push(n)),t.idMap[n.bare]})}unzipModules(i,t){return i[p.Modules]?i[p.Modules].split(S).map(e=>{let s=e.split(m),n=0,c={count:this.zipSvc.parseRational(this.zipSvc.parseString(s[n++])),id:this.zipSvc.parseString(s[n++],t?.modules)};return V(c),c}):[]}zipBeaconArray(i,t,r,e){return i.map((s,n)=>{let c=this.zipSvc.zipTruthyString(s.count?.toString()),o=this.zipSvc.zipTruthyArray(t[n]),l=this.zipSvc.zipTruthyString(s.total?.toString()),h={bare:this.zipSvc.zipFields([c,o,this.zipSvc.zipTruthyString(s.id),l]),hash:this.zipSvc.zipFields([c,o,this.zipSvc.zipTruthyNString(s.id,e.beacons),l])};return r.idMap[h.bare]==null&&(r.idMap[h.bare]=r.list.length,r.list.push(h)),r.idMap[h.bare]})}unzipBeacons(i,t,r){return i[p.Beacons]?i[p.Beacons].split(S).map(s=>{let n=s.split(m),c=0,o={count:this.zipSvc.parseRational(this.zipSvc.parseString(n[c++])),modules:this.zipSvc.parseArray(n[c++])?.map(l=>B(t[Number(l)],{})),id:this.zipSvc.parseString(n[c++],r?.beacons),total:this.zipSvc.parseRational(this.zipSvc.parseString(n[c++]))};return V(o),o}):[]}zipObjectives(i,t,r){let e=this.zipSvc.zipList(t.map(s=>{let n=this.zipSvc.zipDiffString(s.value.toString(),"1"),c=this.zipSvc.zipDiffNumber(s.unit,q.Items),o=this.zipSvc.zipDiffNumber(s.type,x.Output),l=this.zipSvc.zipTruthyArray(i.objectiveSettings.moduleMap[s.id]),h=this.zipSvc.zipTruthyArray(i.objectiveSettings.beaconMap[s.id]),a=this.zipSvc.zipTruthyNumber(s.overclock),u=this.zipSvc.zipTruthyBool(s.checked);return{bare:this.zipSvc.zipFields([s.targetId,n,c,o,this.zipSvc.zipTruthyString(s.machineId),l,h,a,u,this.zipSvc.zipTruthyString(s.fuelId)]),hash:this.zipSvc.zipFields([this.zipSvc.zipTruthyNString(s.targetId,oi(s)?r.recipes:r.items),n,c,o,this.zipSvc.zipTruthyNString(s.machineId,r.machines),l,h,a,u,this.zipSvc.zipTruthyNString(s.fuelId,r.fuels)])}}));e.bare.length&&(i.objectives.bare+=`${p.Objectives}=${e.bare}`,i.objectives.hash+=`${p.Objectives}${e.hash}`)}unzipObjectives(i,t,r,e){let s=i[p.Objectives].split(S),n=[],c={},o=1;for(let l of s){let h=l.split(m),a=0,u=o.toString(),z={id:o.toString(),targetId:h[a++],value:B(this.zipSvc.parseRational(h[a++]),H.one),unit:this.zipSvc.parseNumber(h[a++])??q.Items,type:this.zipSvc.parseNumber(h[a++])??x.Output,machineId:this.zipSvc.parseString(h[a++],e?.machines),modules:this.zipSvc.parseArray(h[a++])?.map(d=>t[Number(d)]??{}),beacons:this.zipSvc.parseArray(h[a++])?.map(d=>r[Number(d)]??{}),overclock:this.zipSvc.parseRational(h[a++]),checked:this.zipSvc.parseBool(h[a++]),fuelId:this.zipSvc.parseString(h[a++],e?.fuels)};e&&(z.targetId=B(this.zipSvc.parseNString(z.targetId,oi(z)?e.recipes:e.items),"")),V(z),n.push(u),c[u]=z,o++}return{ids:n,index:o,entities:c}}zipItems(i,t,r){let e=this.zipSvc.zipList(Object.keys(t).map(s=>{let n=t[s],c=this.zipSvc.zipTruthyBool(n.excluded),o=this.zipSvc.zipTruthyBool(n.checked);return{bare:this.zipSvc.zipFields([s,c,this.zipSvc.zipTruthyString(n.beltId),this.zipSvc.zipTruthyString(n.wagonId),o]),hash:this.zipSvc.zipFields([this.zipSvc.zipTruthyNString(s,r.items),c,this.zipSvc.zipTruthyNString(n.beltId,r.belts),this.zipSvc.zipTruthyNString(n.wagonId,r.wagons),o])}}));e.bare.length&&(i.config.bare+=`&${p.Items}=${e.bare}`,i.config.hash+=`&${p.Items}${e.hash}`)}unzipItems(i,t){let r=i[p.Items].split(S),e={};for(let s of r){let n=s.split(m),c=0,o=B(this.zipSvc.parseString(n[c++],t?.items),""),l={excluded:this.zipSvc.parseBool(n[c++]),beltId:this.zipSvc.parseString(n[c++],t?.belts),wagonId:this.zipSvc.parseString(n[c++],t?.wagons),checked:this.zipSvc.parseBool(n[c++])};V(l),e[o]=l}return e}zipRecipes(i,t,r){let e=this.zipSvc.zipList(Object.keys(t).map(s=>{let n=t[s],c=this.zipSvc.zipTruthyBool(n.excluded),o=this.zipSvc.zipTruthyArray(i.recipeSettings.moduleMap[s]),l=this.zipSvc.zipTruthyArray(i.recipeSettings.beaconMap[s]),h=this.zipSvc.zipTruthyNumber(n.overclock),a=this.zipSvc.zipTruthyNumber(n.cost),u=this.zipSvc.zipTruthyBool(n.checked);return{bare:this.zipSvc.zipFields([s,c,this.zipSvc.zipTruthyString(n.machineId),o,l,h,a,u,this.zipSvc.zipTruthyString(n.fuelId)]),hash:this.zipSvc.zipFields([this.zipSvc.zipTruthyNString(s,r.recipes),c,this.zipSvc.zipTruthyNString(n.machineId,r.machines),o,l,h,a,u,this.zipSvc.zipTruthyNString(n.fuelId,r.fuels)])}}));e.bare.length&&(i.config.bare+=`&${p.Recipes}=${e.bare}`,i.config.hash+=`&${p.Recipes}${e.hash}`)}unzipRecipes(i,t,r,e){let s=i[p.Recipes].split(S),n={};for(let c of s){let o=c.split(m),l=0,h=this.zipSvc.parseString(o[l++],e?.recipes)??"",a={excluded:this.zipSvc.parseBool(o[l++]),machineId:this.zipSvc.parseString(o[l++],e?.machines),modules:this.zipSvc.parseArray(o[l++])?.map(u=>t[Number(u)]??{}),beacons:this.zipSvc.parseArray(o[l++])?.map(u=>r[Number(u)]??{}),overclock:this.zipSvc.parseRational(o[l++]),cost:this.zipSvc.parseRational(o[l++]),checked:this.zipSvc.parseBool(o[l++]),fuelId:this.zipSvc.parseString(o[l++],e?.fuels)};V(a),n[h]=a}return n}zipMachines(i,t,r){let e=t.ids?R:"",s=this.zipSvc.zipTruthyArray(i.machineSettings.beaconMap[""]),n=this.zipSvc.zipTruthyNumber(t.overclock),c=[{bare:this.zipSvc.zipFields([e,this.zipSvc.zipTruthyArray(t.moduleRankIds),s,this.zipSvc.zipTruthyArray(t.fuelRankIds),n]),hash:this.zipSvc.zipFields([e,this.zipSvc.zipTruthyNArray(t.moduleRankIds,r.modules),s,this.zipSvc.zipTruthyNArray(t.fuelRankIds,r.fuels),n])}];(t.ids??Object.keys(t.entities)).forEach(h=>{let a=t.entities[h]??{},u=this.zipSvc.zipTruthyArray(i.machineSettings.moduleMap[h]),z=this.zipSvc.zipTruthyArray(i.machineSettings.beaconMap[h]),d=this.zipSvc.zipTruthyNumber(a.overclock);c.push({bare:this.zipSvc.zipFields([h,u,z,this.zipSvc.zipTruthyString(a.fuelId),d]),hash:this.zipSvc.zipFields([this.zipSvc.zipTruthyNString(h,r.machines),u,z,this.zipSvc.zipTruthyNString(a.fuelId,r.fuels),d])})});let l=this.zipSvc.zipList(c);l.bare.length&&(i.config.bare+=`&${p.Machines}=${l.bare}`,i.config.hash+=`&${p.Machines}${l.hash}`)}unzipMachines(i,t,r,e){let s=i[p.Machines].split(S),n={entities:{}},c;for(let o=0;o<s.length;o++){let h=s[o].split(m),a=0,u=h[a++];o===0&&u===R&&(c=[],u=""),u&&e&&(u=B(this.zipSvc.parseNString(u,e.machines),"")),u&&c&&c.push(u);let z=h[a++],d=this.zipSvc.parseArray(h[a++])?.map(I=>r[Number(I)]??{}),y=h[a++],T=this.zipSvc.parseRational(h[a++]);if(u){let I={modules:this.zipSvc.parseArray(z)?.map($=>t[Number($)]??{}),beacons:d,fuelId:this.zipSvc.parseString(y,e?.fuels),overclock:T};V(I),Object.keys(I).length&&(n.entities[u]=I)}else{let I=this.zipSvc.parseArray(z,e?.modules),$=this.zipSvc.parseArray(y,e?.fuels);c!=null&&(n.ids=c),I!=null&&(n.moduleRankIds=I),d!=null&&(n.beacons=d),$!=null&&(n.fuelRankIds=$),T!=null&&(n.overclock=T)}}return n}zipSettings(i,t,r){let e=A.initialState,s=this.zipSvc.zipDiffDisplayRate(t.displayRate,e.displayRate),n=this.zipSvc.zipDiffNumber(t.preset,e.preset),c=this.zipSvc.zipDiffNumber(t.inserterCapacity,e.inserterCapacity),o=this.zipSvc.zipDiffNumber(t.inserterTarget,e.inserterTarget),l=this.zipSvc.zipDiffRational(t.beaconReceivers,e.beaconReceivers),h=this.zipSvc.zipDiffBool(t.netProductionOnly,e.netProductionOnly),a=this.zipSvc.zipDiffRational(t.costs.factor,e.costs.factor),u=this.zipSvc.zipDiffRational(t.costs.machine,e.costs.machine),z=this.zipSvc.zipDiffRational(t.costs.unproduceable,e.costs.unproduceable),d=this.zipSvc.zipDiffRational(t.costs.excluded,e.costs.excluded),y=this.zipSvc.zipDiffRational(t.costs.surplus,e.costs.surplus),T=this.zipSvc.zipDiffRational(t.costs.maximize,e.costs.maximize),I=this.zipSvc.zipDiffBool(t.surplusMachinesOutput,e.surplusMachinesOutput),$=this.zipSvc.zipDiffRational(t.costs.footprint,e.costs.footprint),si={bare:this.zipSvc.zipFields([this.zipSvc.zipDiffString(t.modId,e.modId),this.zipSvc.zipDiffNullableArray(t.researchedTechnologyIds,e.researchedTechnologyIds),s,n,this.zipSvc.zipDiffString(t.beltId,e.beltId),this.zipSvc.zipDiffRational(t.flowRate,e.flowRate),this.zipSvc.zipDiffRational(t.miningBonus,e.miningBonus),this.zipSvc.zipDiffRational(t.researchBonus,e.researchBonus),c,o,this.zipSvc.zipDiffString(t.cargoWagonId,e.cargoWagonId),this.zipSvc.zipDiffString(t.fluidWagonId,e.fluidWagonId),this.zipSvc.zipDiffString(t.pipeId,e.pipeId),l,this.zipSvc.zipDiffString(t.proliferatorSprayId,e.proliferatorSprayId),h,this.zipSvc.zipDiffNumber(t.maximizeType,e.maximizeType),a,u,z,d,y,T,I,$]),hash:this.zipSvc.zipFields([this.zipSvc.zipDiffNullableNArray(t.researchedTechnologyIds,e.researchedTechnologyIds,r.technologies),s,n,this.zipSvc.zipDiffNString(t.beltId,e.beltId,r.belts),this.zipSvc.zipDiffNRational(t.flowRate,e.flowRate),this.zipSvc.zipDiffNRational(t.miningBonus,e.miningBonus),this.zipSvc.zipDiffNRational(t.researchBonus,e.researchBonus),c,o,this.zipSvc.zipDiffNString(t.cargoWagonId,e.cargoWagonId,r.wagons),this.zipSvc.zipDiffNString(t.fluidWagonId,e.fluidWagonId,r.wagons),this.zipSvc.zipDiffNString(t.pipeId,e.pipeId,r.belts),l,this.zipSvc.zipDiffNString(t.proliferatorSprayId,e.proliferatorSprayId,r.modules),h,this.zipSvc.zipDiffNNumber(t.maximizeType,e.maximizeType),a,u,z,d,y,T,I,$])};si.bare.length&&(i.config.bare+=`&${p.Settings}=${encodeURIComponent(si.bare)}`,i.config.hash+=`&${p.Settings}${si.hash}`)}unzipSettings(i,t){let e=i[p.Settings].split(m),s=0,n={modId:t==null?this.zipSvc.parseString(e[s++]):void 0,researchedTechnologyIds:this.zipSvc.parseNullableArray(e[s++],t?.technologies),displayRate:this.zipSvc.parseDisplayRate(e[s++]),preset:this.zipSvc.parseNumber(e[s++]),beltId:this.zipSvc.parseString(e[s++],t?.belts),flowRate:this.zipSvc.parseRational(e[s++],t!=null),miningBonus:this.zipSvc.parseRational(e[s++],t!=null),researchBonus:this.zipSvc.parseRational(e[s++],t!=null),inserterCapacity:this.zipSvc.parseNumber(e[s++]),inserterTarget:this.zipSvc.parseNumber(e[s++]),cargoWagonId:this.zipSvc.parseString(e[s++],t?.wagons),fluidWagonId:this.zipSvc.parseString(e[s++],t?.wagons),pipeId:this.zipSvc.parseString(e[s++],t?.belts),beaconReceivers:this.zipSvc.parseRational(e[s++]),proliferatorSprayId:this.zipSvc.parseString(e[s++],t?.modules),netProductionOnly:this.zipSvc.parseBool(e[s++]),maximizeType:this.zipSvc.parseNumber(e[s++],t!=null),costs:{factor:this.zipSvc.parseRational(e[s++]),machine:this.zipSvc.parseRational(e[s++]),unproduceable:this.zipSvc.parseRational(e[s++]),excluded:this.zipSvc.parseRational(e[s++]),surplus:this.zipSvc.parseRational(e[s++]),maximize:this.zipSvc.parseRational(e[s++])},surplusMachinesOutput:this.zipSvc.parseBool(e[s++])};return n.costs.footprint=this.zipSvc.parseRational(e[s++]),V(n),n.costs&&V(n.costs),n}static \u0275fac=function(t){return new(t||f)};static \u0275prov=w({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();export{Mi as a,Ti as b,Mt as c};
