import{a as Ce}from"./chunk-EFWQORW2.js";import{$ as V,Ae as te,B as we,Bd as T,Dd as K,E as Me,L as J,La as xe,Od as b,Rd as pe,S as ee,Sc as W,Uc as Oe,Ud as ae,V as P,Vd as ie,Wd as Ee,X as D,Xc as Fe,Xd as De,Y as Re,Yc as k,bd as Ne,c as ve,d as be,da as w,dd as R,e as Ie,ed as M,fd as g,gd as O,hd as Be,id as A,jd as Y,k as oe,kd as ke,m as ye,mc as Ae,md as _,nd as Te,o as G,oe as $,p as q,vc as Ve,we as $e,z as je}from"./chunk-RTAIGCF6.js";import{a as ze,j as x}from"./chunk-TWZW5B45.js";function F(d){Object.keys(d).filter(C=>d[C]===void 0).forEach(C=>delete d[C])}function le(d){let C=new Map;return e=>{let i=C.get(e);return i!=null||(i=d(e),C.set(e,i)),i}}var Z=(()=>{class d{base64codes=new Uint8Array(256).fill(255);constructor(){for(let e=0;e<A.length;e++)this.base64codes[A.charCodeAt(e)]=e;this.base64codes[95]=0}nToId=le(e=>e/Y>=1?this.nToId(Math.floor(e/Y))+this.nToId(e%Y):A[e]);idToN=le(e=>{let i=ke[e[0]];return e.length>1?(e=e.substring(1),i*Math.pow(Y,e.length)+this.idToN(e)):i});deflate(e){return x(this,null,function*(){let i=yield this.compress(e,"deflate");return this.bytesToBase64(i)})}inflate(e){return x(this,null,function*(){try{return yield this.inflateStr(e)}catch{console.warn("Router failed to parse url, checking for missing trailing characters...")}try{return yield this.inflateMend(e,"-")}catch{}try{return yield this.inflateMend(e,".")}catch{}return yield this.inflateMend(e,"_")})}inflateMend(e,i){return x(this,null,function*(){let t=yield this.inflateStr(e+i);if(!t)throw new Error("Failed to parse, generated empty string");return console.warn(`Router mended url by appending '${i}'`),t})}inflateStr(e){return this.decompress(this.base64ToBytes(e))}bytesToBase64(e){let i="",t,s=e.length;for(t=2;t<s;t+=3)i+=A[e[t-2]>>2],i+=A[(e[t-2]&3)<<4|e[t-1]>>4],i+=A[(e[t-1]&15)<<2|e[t]>>6],i+=A[e[t]&63];return t===s+1&&(i+=A[e[t-2]>>2],i+=A[(e[t-2]&3)<<4],i+="__"),t===s&&(i+=A[e[t-2]>>2],i+=A[(e[t-2]&3)<<4|e[t-1]>>4],i+=A[(e[t-1]&15)<<2],i+="_"),i}getBase64Code(e){if(e>=this.base64codes.length)throw new Error("Unable to parse base64 string.");let i=this.base64codes[e];if(i===255)throw new Error("Unable to parse base64 string.");return i}base64ToBytes(e){if(e.length%4!==0)throw new Error("Unable to parse base64 string.");let i=e.indexOf("_");if(i!==-1&&i<e.length-2)throw new Error("Unable to parse base64 string.");let t=e.endsWith("__")?2:e.endsWith("_")?1:0,s=e.length,r=new Uint8Array(3*(s/4)),n;for(let c=0,o=0;c<s;c+=4,o+=3)n=this.getBase64Code(e.charCodeAt(c))<<18|this.getBase64Code(e.charCodeAt(c+1))<<12|this.getBase64Code(e.charCodeAt(c+2))<<6|this.getBase64Code(e.charCodeAt(c+3)),r[o]=n>>16,r[o+1]=n>>8&255,r[o+2]=n&255;return r.subarray(0,r.length-t)}compress(e,i="deflate"){return x(this,null,function*(){let t=new TextEncoder().encode(e),s=new CompressionStream(i),r=s.writable.getWriter();r.write(t),r.close();let n=new Response(s.readable).arrayBuffer();return new Uint8Array(yield n)})}decompress(e,i="deflate"){return x(this,null,function*(){let t=new DecompressionStream(i),s=t.writable.getWriter();s.write(e).catch(()=>{}),s.close().catch(()=>{});let r=new Response(t.readable).arrayBuffer();return new TextDecoder().decode(yield r)})}static \u0275fac=function(i){return new(i||d)};static \u0275prov=V({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})();var Ue=(()=>{class d{http=w(Ae);store=w(W);translateSvc=w(te);cacheData={};cacheHash={};cacheI18n={};initialize(){q([this.store.select($.selectModId),this.translateSvc.lang$]).subscribe(([e])=>{this.requestData(e).subscribe()})}requestData(e){let i,t,s;this.cacheData[e]||(this.cacheData[e]=this.http.get(`data/${e}/data.json`).pipe(D(u=>i=u),ee()));let r=this.cacheData[e];this.cacheHash[e]||(this.cacheHash[e]=this.http.get(`data/${e}/hash.json`).pipe(D(u=>t=u),ee()));let n=this.cacheHash[e],c=this.translateSvc.currentLang,o=`${e}-${c}`,p=c==="en",l;return p?l=oe(null):(this.cacheI18n[o]||(this.cacheI18n[o]=this.http.get(`data/${e}/i18n/${c}.json`).pipe(we(()=>(console.warn(`No localization file found for ${o}`),oe(null))),D(u=>s=u??void 0),ee())),l=this.cacheI18n[o]),q([r,n,l]).pipe(D(()=>{(i||t||s)&&this.store.dispatch(Ee.loadMod({id:e,i18nId:o,data:i,hash:t,i18n:s}))}))}static \u0275fac=function(i){return new(i||d)};static \u0275prov=V({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})();var Le=(()=>{class d{event(e,i){Oe.production&&gtag("event",e,{event_category:i})}static \u0275fac=function(i){return new(i||d)};static \u0275prov=V({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})();var se=(()=>{class d{compressionSvc=w(Z);zipFields(e){return e.join(g).replace(/\**$/,"")}zipString(e){return e??""}zipRational(e){return e==null?"":e.toString()}zipNumber(e){return e==null?"":e.toString()}zipArray(e){return e==null?"":e.length?e.join(M):R}zipNString(e,i){return e==null?"":this.compressionSvc.nToId(i.indexOf(e))}zipDiffSubset(e,i,t,s=t){if(e==null||i!=null&&Array.from(e).every(p=>i.has(p)))return"";if(e.size===0)return R;let r=new Set(t),n=[],c,o;return s.forEach((p,l)=>{if(r.has(p))if(e.has(p)){let u=this.compressionSvc.nToId(l);c==null?c=u:o=u}else c!=null&&(o==null?n.push(c):n.push(c+M+o),c=void 0,o=void 0)}),c!=null&&(o==null?n.push(c):n.push(c+M+o)),n.join(g)}zipDiffString(e,i,t){return e===i||e==null?"":[e,this.compressionSvc.nToId(t.indexOf(e))]}zipDiffNumber(e,i){return e===i||e==null?"":e.toString()}zipDiffRational(e,i){return e==null||i!=null&&e.eq(i)?"":e.toString()}zipDiffBool(e,i){return e===i?"":e?O:Be}zipDiffIndices(e,i){let t=e!=null?e.length>0?e.join(M):R:"",s=i!=null?i.length>0?i.join(M):R:"";return t===s?"":t}zipDiffArray(e,i,t){let s=e!=null?e.length>0?e.join(M):R:"",r=i!=null?i.length>0?i.join(M):R:"";return s===r?"":e==null||e.length===0?s:[s,e.map(n=>this.compressionSvc.nToId(t.indexOf(n))).join(M)]}parseString(e,i){if(i!=null)return this.parseNString(e,i);if(e?.length)return e}parseBool(e){if(e?.length)return e===O}parseNumber(e){if(e?.length)return Number(e)}parseRational(e){if(e?.length)return _(e)}parseArray(e,i){if(i)return this.parseNArray(e,i);if(e?.length)return e===R?[]:e.split(M)}parseIndices(e,i){if(e?.length)return e===R?[]:e.split(M).map(t=>Number(t)).map(t=>i[t]??{})}parseNString(e,i){let t=this.parseString(e);return t==null?t:i[this.compressionSvc.idToN(t)]}parseNArray(e,i){let t=this.parseArray(e);return t==null?t:t.map(s=>i[this.compressionSvc.idToN(s)])}parseSubset(e,i){if(!e?.length)return;if(e===R)return new Set;let t=e.split(g),s=new Set;for(let r of t){let[n,c]=r.split(M).map(l=>this.compressionSvc.idToN(l)),o=c!=null?c+1:n+1;i.slice(n,o).forEach(l=>s.add(l))}return s}set(e,i,t){return s=>(s=s.bind(this),(r,n,...c)=>{let o=n(i),p=n(t),l=s(o,p,...c),u,f;Array.isArray(l)?[u,f]=[...l]:u=f=l,u&&(e.bare[r]=u,e.hash[r]=f)})}get(e){return i=>(i=i.bind(this),(t,...s)=>i(e[t],...s))}static \u0275fac=function(i){return new(i||d)};static \u0275prov=V({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})();var S="_",ne="?",a=function(d){return d.Version="v",d.Mod="b",d.Objectives="p",d.RecipeObjectives="q",d.Items="i",d.Recipes="r",d.Machines="f",d.Modules="m",d.Beacons="e",d.Settings="s",d.Zip="z",d}(a||{}),re=function(d){return d.ExpensiveDeprecation="The expensive setting has been removed. Please use or request an expensive data set instead.",d.LimitStepDeprecation="Limit steps have been replaced by limit objectives. Results may differ if using multiple objectives as limits apply to all objectives.",d}(re||{}),Pe=(()=>{class d{store=w(W);analyticsSvc=w(Le);compressionSvc=w(Z);contentSvc=w(Ce);translateSvc=w(te);zipSvc=w(se);migrate(e,i){if(Object.keys(i).length===0)return{modId:e??$.initialState.modId,params:{},isBare:!0};i=ze({},i);let t=k(i.v,b.Version0);this.analyticsSvc.event("unzip_version",t);let s=i.z==null;(s||t===b.Version0)&&Object.keys(i).forEach(c=>{Array.isArray(i[c])?i[c]=i[c].map(o=>decodeURIComponent(o)):i[c]=decodeURIComponent(i[c])});let r=this.migrateAny(e,i,s,t);return this.displayWarnings(r.warnings),["o","i","r","m","e","b"].forEach(c=>{let o=r.params[c];typeof o=="string"&&(r.params[c]=[o])}),{modId:r.modId,params:r.params,isBare:r.isBare}}migrateAny(e,i,t,s){let n={modId:e,params:i,warnings:[],isBare:t};switch(s){case b.Version0:return this.migrateV0(n);case b.Version1:return this.migrateV1(n);case b.Version2:return this.migrateV2(n);case b.Version3:return this.migrateV3(n);case b.Version4:return this.migrateV4(n);case b.Version5:return this.migrateV5(n);case b.Version6:return this.migrateV6(n);case b.Version7:return this.migrateV7(n);case b.Version8:return this.migrateV8(n);case b.Version9:return this.migrateV9(n);case b.Version10:return this.migrateV10(n);default:return n}}migrateV0(e){let{params:i}=e;if(i[a.Settings]){let s=i[a.Settings].split(g),r=this.zipSvc.parseString(s[0]);r=r&&ie.modHash[ie.modHashV0.indexOf(r)],r=r??"";let n=this.zipSvc.parseNumber(s[6])??60,c=n===1?"0":n===3600?"2":"1";i[a.Settings]=this.zipSvc.zipFields([r,c,i[a.Mod],s[1],s[3],s[4],s[5],s[7],s[8],s[10],s[9],s[2],s[11],s[12]])}else i[a.Mod]&&(i[a.Settings]=this.zipSvc.zipFields([ne,ne,i[a.Mod]]));return delete i[a.Mod],i[a.Version]=b.Version1,this.migrateV1(e)}migrateV1(e){let{params:i,warnings:t}=e;if(i[a.Settings]){let r=i[a.Settings].split(g),n=11;if(r.length>n){let c=r.splice(n,1);this.zipSvc.parseBool(c[0])&&t.push(re.ExpensiveDeprecation)}i[a.Settings]=this.zipSvc.zipFields(r)}return i[a.Version]=b.Version4,this.migrateV4(e)}migrateV2(e){let{params:i}=e;if(i[a.Recipes]){let s=i[a.Recipes].split(S),r=[],n=3;for(let c of s){let o=c.split(g);if(o.length>n){let p=this.parseNNumber(o[n])?.toString();o[n]=this.zipSvc.zipString(p)}r.push(this.zipSvc.zipFields(o))}i[a.Recipes]=r.join(S)}if(i[a.Machines]){let s=i[a.Machines].split(S),r=[],n=2;for(let c of s){let o=c.split(g);if(o.length>n){let p=this.parseNNumber(o[n])?.toString();o[n]=this.zipSvc.zipString(p)}r.push(this.zipSvc.zipFields(o))}i[a.Machines]=r.join(S)}return i[a.Version]=b.Version3,this.migrateV3(e)}migrateV3(e){let{params:i,warnings:t}=e;if(i[a.Settings]){let r=i[a.Settings].split(g),n=10;if(r.length>n){let c=r.splice(n,1);this.zipSvc.parseBool(c[0])&&t.push(re.ExpensiveDeprecation)}i[a.Settings]=this.zipSvc.zipFields(r)}return i[a.Version]=b.Version5,this.migrateV5(e)}migrateInlineBeaconsSection(e,i,t,s){if(e[i]){let n=e[i].split(S),c=[];for(let o of n.map(p=>p.split(g))){let p=t+1,l=p+1,u=l+3;if(o.length>t){let f,m,y;o.length>u&&(y=o.splice(u,1)[0]),o.length>l&&(f=o.splice(l,1)[0]),o.length>p&&(m=o.splice(p,1)[0]);let h=o[t];o[t]=this.zipSvc.zipArray([s.length]),s.push(this.zipSvc.zipFields([h,this.zipSvc.zipString(m),this.zipSvc.zipString(f),this.zipSvc.zipString(y)]))}c.push(this.zipSvc.zipFields(o))}e[i]=c.join(S)}}migrateInlineBeacons(e){let i=[];return this.migrateInlineBeaconsSection(e.params,a.RecipeObjectives,4,i),this.migrateInlineBeaconsSection(e.params,a.Recipes,3,i),i.length&&(e.params[a.Beacons]=i.join(S)),e}migrateV4(e){return e=this.migrateInlineBeacons(e),e.params[a.Version]=b.Version6,this.migrateV6(e)}migrateV5(e){return e=this.migrateInlineBeacons(e),e.params[a.Version]=b.Version7,this.migrateV7(e)}migrateInsertField(e,i,t){if(e[i]){let s=e[i].split(S);for(let r=0;r<s.length;r++){let n=s[r].split(g);n.length>t&&(n.splice(t,0,""),s[r]=this.zipSvc.zipFields(n))}e[i]=s.join(S)}}migrateDeleteField(e,i,t){if(e[i]){let s=e[i].split(S);for(let r=0;r<s.length;r++){let n=s[r].split(g);n.length>t&&(n.splice(t,1),s[r]=this.zipSvc.zipFields(n))}e[i]=s.join(S)}}migrateMoveUpField(e,i,t){if(e[i]!=null){let s=e[i];for(e.splice(i,1),e.length>t&&e.splice(t,0,"");e.length<=t;)e.push("");e[t]=s}}migrateToV8(e){let{params:i,isBare:t}=e,s=!1;if(this.migrateInsertField(i,a.RecipeObjectives,2),i[a.Objectives]){let r=i[a.Objectives].split(S),n=[...r];for(let c=0;c<r.length;c++){let p=r[c].split(g);if(p[2]==="3")if(t){let l=i[a.RecipeObjectives]?i[a.RecipeObjectives].split(S):[];if(p.length>3){let u=[p[3],p[1],T.Limit.toString()],f=[p[0],"1",T.Maximize.toString()];l.push(this.zipSvc.zipFields(f)),l.push(this.zipSvc.zipFields(u)),s=!0}else l.push(this.zipSvc.zipFields([p[0],p[1]]));n.splice(c,1),i[a.RecipeObjectives]=l.join(S)}else p[2]="0",n[c]=this.zipSvc.zipFields(p);else if(p.length>3){let l=[p[3],p[1],p[2],T.Limit.toString()],u=[p[0],"1","",T.Maximize.toString()];n[c]=this.zipSvc.zipFields(u),n.push(this.zipSvc.zipFields(l)),s=!0}}s&&e.warnings.push(re.LimitStepDeprecation),i[a.Objectives]=n.join(S)}if(this.migrateDeleteField(i,a.Items,4),this.migrateInsertField(i,a.Recipes,1),i[a.Settings]){let r=i[a.Settings].split(g),n=t?1:0;if(r.length>2+n){let c=this.zipSvc.parseArray(r[2+n]);if(c){let o=i[a.Recipes],p=o?o.split(S):[];for(let l of c){let u=!1;for(let f=0;f<p.length;f++){let m=p[f].split(g);m[0]===l&&(u=!0,m[1]=O,p[f]=this.zipSvc.zipFields(m))}u||p.push(this.zipSvc.zipFields([l,O]))}i[a.Recipes]=p.join(S)}r.splice(2+n,1)}r.splice(n,0,""),this.migrateMoveUpField(r,16+n,20+n),this.migrateMoveUpField(r,15+n,19+n),this.migrateMoveUpField(r,14+n,18+n),this.migrateMoveUpField(r,13+n,17+n),i[a.Settings]=this.zipSvc.zipFields(r)}return i[a.Version]=b.Version8,e}migrateV6(e){return e.isBare=!0,this.migrateV8(this.migrateToV8(e))}migrateV7(e){return e.isBare=!1,this.migrateV8(this.migrateToV8(e))}migrateV8(e){let{params:i}=e;if(i[a.RecipeObjectives]){let t=[];i[a.Objectives]&&(t=i[a.Objectives].split(S));let s=i[a.RecipeObjectives].split(S);for(let r of s){let n=r.split(g),c=this.zipSvc.zipFields([n[0],n[1],"3",n[2],n[3],n[4],n[5],n[6],n[7]]);t.push(c)}i[a.RecipeObjectives]="",i[a.Objectives]=t.join(S)}return this.migrateV9(e)}migrateInlineModulesSection(e,i,t,s){if(e[i]){let n=e[i].split(S),c=[];for(let o of n.map(p=>p.split(g))){if(o.length>t){let p=o[t],l=this.zipSvc.parseArray(p);if(l==null)continue;let u=new Map;for(let m of l){let y=u.get(m)??0;u.set(m,y+1)}let f=Array.from(u.keys()).map((m,y)=>s.length+y);o[t]=this.zipSvc.zipArray(f);for(let m of u.keys())s.push(this.zipSvc.zipFields([k(u.get(m)?.toString(),""),m]))}c.push(this.zipSvc.zipFields(o))}e[i]=c.join(S)}}migrateV9(e){let{params:i}=e,t=[];if(this.migrateInlineModulesSection(e.params,a.Beacons,1,t),this.migrateInlineModulesSection(e.params,a.Recipes,3,t),this.migrateInlineModulesSection(e.params,a.Objectives,5,t),e.params[a.Machines]){let r=i[a.Machines].split(S),n=[],c=e.params[a.Beacons]?e.params[a.Beacons].split(S):[],o=2,p=o+1,l=p+1;r.map(u=>u.split(g)).forEach((u,f)=>{if(f===0&&u[0]===O&&(u[0]=R),this.migrateMoveUpField(u,5,6),u[0]!==R&&u[0]!==""&&u.length>1){let m=u[1];if(m){let y=m.split(M)[0];u[1]=this.zipSvc.zipArray([t.length]),t.push(this.zipSvc.zipFields(["",y]))}}if(u.length>2){let m,y;if(u.length>l&&(m=u.splice(l,1)[0]),u.length>p){let I=u.splice(p,1)[0];if(I){let N=I.split(M)[0];y=[t.length],t.push(this.zipSvc.zipFields(["",N]))}}let h=u[o];u[o]=this.zipSvc.zipArray([c.length]),c.push(this.zipSvc.zipFields([h,this.zipSvc.zipArray(y),this.zipSvc.zipString(m)]))}n.push(this.zipSvc.zipFields(u))}),c.length&&(e.params[a.Beacons]=c.join(S)),e.params[a.Machines]=n.join(S)}if(t.length&&(e.params[a.Modules]=t.join(S)),i[a.Settings]){let s=i[a.Settings].split(g),r=e.isBare?5:4;if(s.length>r){let n=s.splice(r,1)[0];if(i[a.Machines]){let c=i[a.Machines].split(S).map(p=>p.split(g)),o=c.find(p=>p[0]===R||p[0]==="");if(o){for(;o.length<4;)o.push("");o[3]=n}else c.unshift(["","","",n]);i[a.Machines]=c.map(p=>this.zipSvc.zipFields(p)).join(S)}else i[a.Machines]=["","","",n].join(g);i[a.Settings]=s.join(g)}}return i[a.Version]=b.Version10,this.migrateV10(e)}migrateV10(e){let{params:i}=e;delete i[a.RecipeObjectives];let t=new Set,s=new Set,r=new Set,n=new Set,c=new Set;function o(v,z){z.size!==0&&(i[v]=Array.from(z).join(M))}let p=i[a.Modules];delete i[a.Modules];let l=p?.split(S),u=i[a.Beacons];delete i[a.Beacons];let f=u?.split(S),m=i[a.Objectives];delete i[a.Objectives];let y=[],h=m?.split(S).map((v,z)=>{let j=v.split(g),U=z.toString();return y.push(U),j[8]===O&&t.add(U),j.splice(8,1),j.join(g)}).filter(v=>v);h?.length&&(i.o=h),t.size&&(i.och=this.zipSvc.zipDiffSubset(t,void 0,y));let I=i[a.Items];delete i[a.Items];let N=I?.split(S).map(v=>{let z=v.split(g),j=z[0];return z[1]===O&&s.add(j),z[4]===O&&r.add(j),z.splice(4,1),z.splice(1,1),z.join(g)}).filter(v=>v);N?.length&&(i.i=N),o("v10iex",s),o("v10ich",r);let B=i[a.Recipes];delete i[a.Recipes];let E=B?.split(S).map(v=>{let z=v.split(g),j=z[0];return z[1]===O&&n.add(j),z[7]===O&&c.add(j),z.splice(7,1),z.splice(1,1),z.join(g)}).filter(v=>v);E?.length&&(i.r=E),o("v10rex",n),o("v10rch",c);let We=i[a.Machines];delete i[a.Machines];let X,he,ue,de,fe,ce=[];We?.split(S).forEach((v,z)=>{let j=v.split(g),U=j[0];z===0?(U===R&&(X=[]),ue=j[1],de=j[2],he=j[3],fe=j[4]):(X?.push(U),j.length>1&&ce.push(v))}),ce.length&&(i.m=ce),i.mmr=X?.join(M),i.mfr=he,i.mer=ue,i.mbe=de,i.moc=fe;let me=i[a.Settings];if(delete i[a.Settings],me){let v=me.split(g),z=e.isBare?v.splice(0,1)[0]:void 0;z&&(e.modId=z);let j=v[0];j!==ne&&o("v10tre",new Set(j.split(M))),["odr","mpr","ibe","ifr","bmi","bre","bic","mit","icw","ifw","ipi","mbr","mps","rnp","omt","cfa","cma","cun","cex","csu","cmx","osm","cfp"].forEach((Se,L)=>{i[Se]=v[L+1]||void 0}),e.isBare||["ifr","bmi","bre","omt"].filter(L=>i[L]!=null).forEach(L=>{i[L]=this.parseNNumber(i[L])?.toString()})}let Ze=i[a.Mod];delete i[a.Mod];let H=Ze;H&&!e.isBare&&(H=ie.modHash[this.compressionSvc.idToN(H)]),H&&(e.modId=H),i.e=l,i.b=f,i.v=b.Version11,F(i);function ge(v){return v.replaceAll(ne,"").replaceAll(R,R)}return Object.keys(i).forEach(v=>{let z=i[v];Array.isArray(z)?i[v]=z.map(j=>ge(j)):i[v]=ge(z)}),e}restoreV10ResearchedTechnologies(e,i){let t=i.items.filter(o=>o.technology),s=t.map(o=>o.id);if(e==null||!s.length)return;let r=new Set(e),n=Te(t),c;do{c=new Set;for(let o of r)n[o].technology?.prerequisites?.filter(l=>!r.has(l)).forEach(l=>c.add(l));c.forEach(o=>r.add(o))}while(c.size);if(r.size!==s.length)return r}parseNNumber(e){if(e?.length)return this.compressionSvc.idToN(e)}parseSet(e,i){if(e==null)return;let t=e.split(M);return i==null?new Set(t):new Set(t.map(s=>i[this.compressionSvc.idToN(s)]))}displayWarnings(e){this.translateSvc.multi(["app.migrationWarning","OK"]).pipe(J()).subscribe(([i,t])=>{for(let s of e)this.contentSvc.confirm({message:s,header:i,acceptLabel:t,rejectVisible:!1})})}static \u0275fac=function(i){return new(i||d)};static \u0275prov=V({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})();var Li=(()=>{class d{router=w(Ve);store=w(W);dataSvc=w(Ue);compressionSvc=w(Z);zipSvc=w(se);migrationSvc=w(Pe);zipConfig=xe(this.empty);version=b.Version11;zipTail={v:this.version};route$=new ve;ready$=new Ie(1);navigating$=new be(!1);get empty(){return{bare:{},hash:{}}}get emptyRecipeSettingsInfo(){return{idMap:{},list:[]}}get emptyMachineSettings(){return{moduleMap:{},beaconMap:{}}}constructor(){this.route$.pipe(P(e=>q({params:e.params,queryParams:e.queryParams})),Re(this.navigating$),je(([e,i])=>!i),G(([e])=>e),P(t=>x(this,[t],function*({params:e,queryParams:i}){return i=yield this.unzipQueryParams(i),{params:e,queryParams:i}})),G(({params:e,queryParams:i})=>this.migrationSvc.migrate(e.id,i)),P(({modId:e,params:i,isBare:t})=>this.updateState(e,i,t))).subscribe(),this.ready$.pipe(J(),D(()=>this.dataSvc.initialize()),P(()=>this.store.select($e.selectZipState)),Me(0),Ne("hash"),G(e=>this.zipState(e.objectives,e.itemsState,e.recipesState,e.machinesState,e.settings,e.data,e.hash)),P(e=>this.updateUrl(e))).subscribe()}updateUrl(e){return x(this,null,function*(){let i=yield this.getHash(e);this.navigating$.next(!0),yield this.router.navigate([],{queryParams:i}),this.navigating$.next(!1);let t=this.router.url,s=t.split("?")[0];(s.endsWith("list")||s.endsWith("flow"))&&(De.routerState=t)})}zipState(e,i,t,s,r,n,c){let o=this.zipModulesBeacons(e,t,s,r,c),p=Object.keys(e.entities).map(l=>e.entities[l]);return this.zipObjectives(o,p,c),this.zipItems(o,i,c),this.zipRecipes(o,t,c),this.zipMachines(o,s,c),this.zipSettings(o,r,e.ids,n,c),this.zipConfig.set(o.config),o}stepHref(e,i,t){return x(this,null,function*(){if(t==null)return null;let s;if(e.itemId!=null&&e.items!=null?s=[{id:"0",targetId:e.itemId,value:e.items,unit:K.Items,type:T.Output}]:e.recipeId!=null&&e.machines!=null&&(s=[{id:"0",targetId:e.recipeId,value:e.machines,unit:K.Machines,type:T.Output}]),s==null)return null;let r={objectives:this.empty,config:i,objectiveSettings:this.emptyMachineSettings,recipeSettings:this.emptyMachineSettings,machineSettings:this.emptyMachineSettings};return this.zipObjectives(r,s,t),yield this.getHash(r)})}getHash(e){return x(this,null,function*(){let i=ae(e.objectives.bare,e.config.bare,this.zipTail),t=ae(e.objectives.hash,e.config.hash,this.zipTail),s=this.toString(t),n={z:yield this.compressionSvc.deflate(s),v:this.version},o=this.toString(i).length,l=this.toString(n).length;return o<Math.max(l,200)?i:n})}toParams(e){let i=e.split("&");return i.some(t=>!t.includes("="))?i.reduce((t,s)=>(t[s[0]]=s.substring(1),t),{}):i.reduce((t,s)=>{let[r,n]=s.split("=");return t[r]=n,t},{})}toString(e){return Object.keys(e).flatMap(i=>{let t=e[i];return Array.isArray(t)?t.map(s=>`${i}=${s}`):`${i}=${t}`},"").join("&")}unzipQueryParams(e){return x(this,null,function*(){let i=e.z;if(i!=null)try{let t=i.replace(/\+/g,"-").replace(/\//g,".").replace(/=/g,"_"),s=yield this.compressionSvc.inflate(t);e=this.toParams(s),e.z=i}catch(t){throw console.error(t),new Error("RouterService failed to parse url")}return e})}updateState(e,i,t){return x(this,null,function*(){if(e==null&&Object.keys(i).length===0)return this.ready$.next();let[s,r]=yield ye(this.dataSvc.requestData(e??$.initialState.modId)),n={},c=t?void 0:r,o=this.unzipModules(i,c),p=this.unzipBeacons(i,o,c);n.objectivesState=this.unzipObjectives(i,o,p,c),n.itemsState=this.unzipItems(i,c),n.recipesState=this.unzipRecipes(i,o,p,c),n.machinesState=this.unzipMachines(i,o,p,c),n.settingsState=this.unzipSettings(e,i,p,k(n.objectivesState?.ids,[]),s,r,c),F(n),this.dispatch(n),this.ready$.next()})}dispatch(e){this.store.dispatch(Fe.load({partial:e})),this.ready$.next()}zipModulesBeacons(e,i,t,s,r){let n=this.emptyRecipeSettingsInfo,c=this.emptyRecipeSettingsInfo,o=I=>this.zipMachineSettings(I,n,c,r),p=o(e.entities),l=o(i),u=o(t),f;if(s.beacons){let I=this.beaconModuleMap(s.beacons,n,r);f=this.zipBeaconArray(s.beacons,I,c,r)}let m=this.empty,y=["bare","hash"];return[["e",n.list],["b",c.list]].forEach(([I,N])=>{N.forEach(B=>{y.forEach(E=>{m[E][I]==null?m[E][I]=[B[E]]:m[E][I].push(B[E])})})}),{objectives:this.empty,config:m,objectiveSettings:p,recipeSettings:l,machineSettings:u,beacons:f}}zipMachineSettings(e,i,t,s){let r=this.emptyMachineSettings;for(let n of Object.keys(e)){let c=e[n];if(c.modules!=null&&(r.moduleMap[n]=this.zipModuleArray(c.modules,i,s)),c.beacons!=null){let o=this.beaconModuleMap(c.beacons,i,s);r.beaconMap[n]=this.zipBeaconArray(c.beacons,o,t,s)}}return r}beaconModuleMap(e,i,t){return e.map(s=>{if(s.modules!=null)return this.zipModuleArray(s.modules,i,t)})}zipModuleArray(e,i,t){return e.map(s=>{let r=this.zipSvc.zipRational(s.count),n={bare:this.zipSvc.zipFields([r,this.zipSvc.zipString(s.id)]),hash:this.zipSvc.zipFields([r,this.zipSvc.zipNString(s.id,t.modules)])};return i.idMap[n.bare]==null&&(i.idMap[n.bare]=i.list.length,i.list.push(n)),i.idMap[n.bare]})}unzipModules(e,i){return e.e==null?[]:e.e.map(t=>{let s=t.split(g),r=0,n={count:this.zipSvc.parseRational(s[r++]),id:this.zipSvc.parseString(s[r++],i?.modules)};return F(n),n})}zipBeaconArray(e,i,t,s){return e.map((r,n)=>{let c=this.zipSvc.zipRational(r.count),o=this.zipSvc.zipArray(i[n]),p=this.zipSvc.zipRational(r.total),l={bare:this.zipSvc.zipFields([c,o,this.zipSvc.zipString(r.id),p]),hash:this.zipSvc.zipFields([c,o,this.zipSvc.zipNString(r.id,s.beacons),p])};return t.idMap[l.bare]==null&&(t.idMap[l.bare]=t.list.length,t.list.push(l)),t.idMap[l.bare]})}unzipBeacons(e,i,t){return e.b==null?[]:e.b.map(s=>{let r=s.split(g),n=0,c={count:this.zipSvc.parseRational(r[n++]),modules:this.zipSvc.parseIndices(r[n++],i),id:this.zipSvc.parseString(r[n++],t?.beacons),total:this.zipSvc.parseRational(r[n++])};return F(c),c})}zipObjectives(e,i,t){if(i.length){e.objectives.bare.o=[],e.objectives.hash.o=[];for(let s of i){let r=this.zipSvc.zipDiffRational(s.value,_.one),n=this.zipSvc.zipDiffNumber(s.unit,K.Items),c=this.zipSvc.zipDiffNumber(s.type,T.Output),o=this.zipSvc.zipArray(e.objectiveSettings.moduleMap[s.id]),p=this.zipSvc.zipArray(e.objectiveSettings.beaconMap[s.id]),l=this.zipSvc.zipNumber(s.overclock);e.objectives.bare.o.push(this.zipSvc.zipFields([s.targetId,r,n,c,this.zipSvc.zipString(s.machineId),o,p,l,this.zipSvc.zipString(s.fuelId)])),e.objectives.hash.o.push(this.zipSvc.zipFields([this.zipSvc.zipNString(s.targetId,pe(s)?t.recipes:t.items),r,n,c,this.zipSvc.zipNString(s.machineId,t.machines),o,p,l,this.zipSvc.zipNString(s.fuelId,t.fuels)]))}}}unzipObjectives(e,i,t,s){if(e.o==null)return;let r=[],n={},c=1;for(let o of e.o){let p=o.split(g),l=0,u=c.toString(),f={id:c.toString(),targetId:p[l++],value:k(this.zipSvc.parseRational(p[l++]),_.one),unit:this.zipSvc.parseNumber(p[l++])??K.Items,type:this.zipSvc.parseNumber(p[l++])??T.Output,machineId:this.zipSvc.parseString(p[l++],s?.machines),modules:this.zipSvc.parseIndices(p[l++],i),beacons:this.zipSvc.parseIndices(p[l++],t),overclock:this.zipSvc.parseRational(p[l++]),fuelId:this.zipSvc.parseString(p[l++],s?.fuels)};s&&(f.targetId=k(this.zipSvc.parseNString(f.targetId,pe(f)?s.recipes:s.items),"")),F(f),r.push(u),n[u]=f,c++}return{ids:r,index:c,entities:n}}zipItems(e,i,t){let s=Object.keys(i);if(s.length){e.config.bare.i=[],e.config.hash.i=[];for(let r of s){let n=i[r];e.config.bare.i.push(this.zipSvc.zipFields([r,this.zipSvc.zipString(n.beltId),this.zipSvc.zipString(n.wagonId)])),e.config.hash.i.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.items),this.zipSvc.zipNString(n.beltId,t.belts),this.zipSvc.zipNString(n.wagonId,t.wagons)]))}}}unzipItems(e,i){if(e.i==null)return;let t={};for(let s of e.i){let r=s.split(g),n=0,c=k(this.zipSvc.parseString(r[n++],i?.items),""),o={beltId:this.zipSvc.parseString(r[n++],i?.belts),wagonId:this.zipSvc.parseString(r[n++],i?.wagons)};F(o),Object.keys(o).length&&(t[c]=o)}return t}zipRecipes(e,i,t){let s=Object.keys(i);if(s.length){e.config.bare.r=[],e.config.hash.r=[];for(let r of s){let n=i[r],c=this.zipSvc.zipArray(e.recipeSettings.moduleMap[r]),o=this.zipSvc.zipArray(e.recipeSettings.beaconMap[r]),p=this.zipSvc.zipNumber(n.overclock),l=this.zipSvc.zipNumber(n.cost);e.config.bare.r.push(this.zipSvc.zipFields([r,this.zipSvc.zipString(n.machineId),c,o,p,l,this.zipSvc.zipString(n.fuelId)])),e.config.hash.r.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.recipes),this.zipSvc.zipNString(n.machineId,t.machines),c,o,p,l,this.zipSvc.zipNString(n.fuelId,t.fuels)]))}}}unzipRecipes(e,i,t,s){if(e.r==null)return;let r={};for(let n of e.r){let c=n.split(g),o=0,p=k(this.zipSvc.parseString(c[o++],s?.recipes),""),l={machineId:this.zipSvc.parseString(c[o++],s?.machines),modules:this.zipSvc.parseArray(c[o++])?.map(u=>i[Number(u)]??{}),beacons:this.zipSvc.parseArray(c[o++])?.map(u=>t[Number(u)]??{}),overclock:this.zipSvc.parseRational(c[o++]),cost:this.zipSvc.parseRational(c[o++]),fuelId:this.zipSvc.parseString(c[o++],s?.fuels)};F(l),Object.keys(l).length&&(r[p]=l)}return r}zipMachines(e,i,t){let s=Object.keys(i);if(s.length){e.config.bare.m=[],e.config.hash.m=[];for(let r of s){let n=i[r],c=this.zipSvc.zipArray(e.machineSettings.moduleMap[r]),o=this.zipSvc.zipArray(e.machineSettings.beaconMap[r]),p=this.zipSvc.zipNumber(n.overclock);e.config.bare.m.push(this.zipSvc.zipFields([r,c,o,this.zipSvc.zipString(n.fuelId),p])),e.config.hash.m.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.machines),c,o,this.zipSvc.zipNString(n.fuelId,t.fuels),p]))}}}unzipMachines(e,i,t,s){if(e.m==null)return;let r={};for(let n of e.m){let c=n.split(g),o=0,p=k(this.zipSvc.parseString(c[o++],s?.machines),""),l={modules:this.zipSvc.parseArray(c[o++])?.map(u=>i[Number(u)]??{}),beacons:this.zipSvc.parseArray(c[o++])?.map(u=>t[Number(u)]??{}),fuelId:this.zipSvc.parseString(c[o++],s?.fuels),overclock:this.zipSvc.parseRational(c[o++])};F(l),Object.keys(l).length&&(r[p]=l)}return r}zipSettings(e,i,t,s,r){let n=$.initialState,c=this.zipSvc.set(e.config,i,n),o=c(this.zipSvc.zipDiffSubset),p=c(this.zipSvc.zipDiffNumber),l=c(this.zipSvc.zipDiffBool),u=c(this.zipSvc.zipDiffString),f=c(this.zipSvc.zipDiffRational),m=c(this.zipSvc.zipDiffArray),y=c(this.zipSvc.zipDiffIndices);o("och",h=>h.checkedObjectiveIds,t),p("omt",h=>h.maximizeType),l("osm",h=>h.surplusMachinesOutput),p("odr",h=>h.displayRate),o("iex",h=>h.excludedItemIds,s.itemIds,r.items),o("ich",h=>h.checkedItemIds,s.itemIds,r.items),u("ibe",h=>h.beltId,r.belts),u("ipi",h=>h.pipeId,r.belts),u("icw",h=>h.cargoWagonId,r.wagons),u("ifw",h=>h.fluidWagonId,r.wagons),f("ifr",h=>h.flowRate),o("rex",h=>h.excludedRecipeIds,s.recipeIds,r.recipes),o("rch",h=>h.checkedRecipeIds,s.recipeIds,r.recipes),l("rnp",h=>h.netProductionOnly),p("mpr",h=>h.preset),m("mmr",h=>h.machineRankIds,r.machines),m("mfr",h=>h.fuelRankIds,r.fuels),m("mer",h=>h.moduleRankIds,r.modules),y("mbe",h=>h===n?void 0:e.beacons),f("moc",h=>h.overclock),f("mbr",h=>h.beaconReceivers),u("mps",h=>h.proliferatorSprayId,r.modules),p("mit",h=>h.inserterTarget),f("bmi",h=>h.miningBonus),f("bre",h=>h.researchBonus),p("bic",h=>h.inserterCapacity),o("tre",h=>h.researchedTechnologyIds,s.technologyIds,r.technologies),f("cfa",h=>h.costs.factor),f("cma",h=>h.costs.machine),f("cfp",h=>h.costs.footprint),f("cun",h=>h.costs.unproduceable),f("cex",h=>h.costs.excluded),f("csu",h=>h.costs.surplus),f("cmx",h=>h.costs.maximize)}unzipSettings(e,i,t,s,r,n,c){let o=this.zipSvc.get(i),p=o(this.zipSvc.parseSubset),l=o(this.zipSvc.parseNumber),u=o(this.zipSvc.parseBool),f=o(this.zipSvc.parseString),m=o(this.zipSvc.parseRational),y=o(this.zipSvc.parseArray),h=o(this.zipSvc.parseIndices),I={modId:e,checkedObjectiveIds:p("och",s),maximizeType:l("omt"),surplusMachinesOutput:u("osm"),displayRate:l("odr"),excludedItemIds:p("iex",n.items),checkedItemIds:p("ich",n.items),beltId:f("ibe",c?.belts),pipeId:f("ipi",c?.belts),cargoWagonId:f("icw",c?.wagons),fluidWagonId:f("ifw",c?.wagons),flowRate:m("ifr"),excludedRecipeIds:p("rex",n.recipes),checkedRecipeIds:p("rch",n.recipes),netProductionOnly:u("rnp"),preset:l("mpr"),machineRankIds:y("mmr",c?.machines),fuelRankIds:y("mfr",c?.fuels),moduleRankIds:y("mer",c?.modules),beacons:h("mbe",t),overclock:m("moc"),beaconReceivers:m("mbr"),proliferatorSprayId:f("mps",c?.modules),inserterTarget:l("mit"),miningBonus:m("bmi"),researchBonus:m("bre"),inserterCapacity:l("bic"),researchedTechnologyIds:p("tre",n.technologies)},N={factor:m("cfa"),machine:m("cma"),footprint:m("cfp"),unproduceable:m("cun"),excluded:m("cex"),surplus:m("csu"),maximize:m("cmx")},B=this.migrationSvc.parseSet.bind(this.migrationSvc);if(i.v10iex&&(I.excludedItemIds=B(i.v10iex,c?.items)),i.v10ich&&(I.checkedItemIds=B(i.v10ich,c?.items)),i.v10rex&&(I.excludedRecipeIds=B(i.v10rex,c?.recipes)),i.v10rch&&(I.checkedRecipeIds=B(i.v10rch,c?.recipes)),i.v10tre&&(I.researchedTechnologyIds=B(i.v10tre,c?.technologies),I.researchedTechnologyIds=this.migrationSvc.restoreV10ResearchedTechnologies(I.researchedTechnologyIds,r)),F(N),Object.keys(N).length&&(I.costs=N),F(I),!!Object.keys(I).length)return I}static \u0275fac=function(i){return new(i||d)};static \u0275prov=V({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})();export{Le as a,Ue as b,Pe as c,Li as d};
