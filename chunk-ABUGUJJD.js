import{a as Ni,b as Bi,d as T,t as Di}from"./chunk-ETDXKBUX.js";import{a as ki,b as Ti,c as Ei}from"./chunk-Q6NEBTW2.js";import{Ac as Mi,Bc as O,Bd as K,Cc as H,D as vi,Dc as wi,Fd as ri,Gc as Y,Hd as Oi,I as W,Id as Fi,Jc as y,K as bi,Kb as yi,Kc as E,L as Ii,O as U,Pc as ni,Rc as N,S as R,Sc as q,Tc as Ri,Xc as xi,ad as G,c as ti,d as fi,hc as ji,k as mi,l as X,m as Si,pd as Ai,qd as Vi,v as gi,vc as _,wc as A,xa as si,xc as x,yc as S,z as zi,zc as F}from"./chunk-UQI3YGXD.js";import{j as V}from"./chunk-TWZW5B45.js";var I=function(u){return u.Version0="0",u.Version1="1",u.Version2="2",u.Version3="3",u.Version4="4",u.Version5="5",u.Version6="6",u.Version7="7",u.Version8="8",u.Version9="9",u.Version10="10",u.Version11="11",u}(I||{});var P=(()=>{let z=class z{constructor(){this.base64codes=new Uint8Array(256).fill(255),this.nToId=ni(i=>i/H>=1?this.nToId(Math.floor(i/H))+this.nToId(i%H):O[i]),this.idToN=ni(i=>{let e=wi[i[0]];return i.length>1?(i=i.substring(1),e*Math.pow(H,i.length)+this.idToN(i)):e});for(let i=0;i<O.length;i++)this.base64codes[O.charCodeAt(i)]=i;this.base64codes[95]=0}deflate(i){return V(this,null,function*(){let e=yield this.compress(i,"deflate");return this.bytesToBase64(e)})}inflate(i){return V(this,null,function*(){try{return yield this.inflateStr(i)}catch{console.warn("Router failed to parse url, checking for missing trailing characters...")}try{return yield this.inflateMend(i,"-")}catch{}try{return yield this.inflateMend(i,".")}catch{}return yield this.inflateMend(i,"_")})}inflateMend(i,e){return V(this,null,function*(){let t=yield this.inflateStr(i+e);if(!t)throw new Error("Failed to parse, generated empty string");return console.warn(`Router mended url by appending '${e}'`),t})}inflateStr(i){return this.decompress(this.base64ToBytes(i))}bytesToBase64(i){let e="",t,n=i.length;for(t=2;t<n;t+=3)e+=O[i[t-2]>>2],e+=O[(i[t-2]&3)<<4|i[t-1]>>4],e+=O[(i[t-1]&15)<<2|i[t]>>6],e+=O[i[t]&63];return t===n+1&&(e+=O[i[t-2]>>2],e+=O[(i[t-2]&3)<<4],e+="__"),t===n&&(e+=O[i[t-2]>>2],e+=O[(i[t-2]&3)<<4|i[t-1]>>4],e+=O[(i[t-1]&15)<<2],e+="_"),e}getBase64Code(i){if(i>=this.base64codes.length)throw new Error("Unable to parse base64 string.");let e=this.base64codes[i];if(e===255)throw new Error("Unable to parse base64 string.");return e}base64ToBytes(i){if(i.length%4!==0)throw new Error("Unable to parse base64 string.");let e=i.indexOf("_");if(e!==-1&&e<i.length-2)throw new Error("Unable to parse base64 string.");let t=i.endsWith("__")?2:i.endsWith("_")?1:0,n=i.length,r=new Uint8Array(3*(n/4)),s;for(let o=0,c=0;o<n;o+=4,c+=3)s=this.getBase64Code(i.charCodeAt(o))<<18|this.getBase64Code(i.charCodeAt(o+1))<<12|this.getBase64Code(i.charCodeAt(o+2))<<6|this.getBase64Code(i.charCodeAt(o+3)),r[c]=s>>16,r[c+1]=s>>8&255,r[c+2]=s&255;return r.subarray(0,r.length-t)}compress(i,e="deflate"){return V(this,null,function*(){let t=new TextEncoder().encode(i),n=new CompressionStream(e),r=n.writable.getWriter();r.write(t),r.close();let s=new Response(n.readable).arrayBuffer();return new Uint8Array(yield s)})}decompress(i,e="deflate"){return V(this,null,function*(){let t=new DecompressionStream(e),n=t.writable.getWriter();n.write(i).catch(()=>{}),n.close().catch(()=>{});let r=new Response(t.readable).arrayBuffer();return new TextDecoder().decode(yield r)})}};z.\u0275fac=function(e){return new(e||z)},z.\u0275prov=U({token:z,factory:z.\u0275fac,providedIn:"root"});let u=z;return u})();var J=(()=>{let z=class z{constructor(){this.compressionSvc=R(P)}zipFields(i){return i.join(S).replace(/\**$/,"")}zipString(i){return i??""}zipRational(i){return i==null?"":i.toString()}zipNumber(i){return i==null?"":i.toString()}zipArray(i){return i==null?"":i.length?i.join(x):A}zipNString(i,e){return i==null?"":this.compressionSvc.nToId(e.indexOf(i))}zipDiffSubset(i,e,t,n=t){if(i==null||e!=null&&Array.from(i).every(p=>e.has(p)))return"";if(i.size===0)return A;let r=new Set(t),s=[],o,c;return n.forEach((p,d)=>{if(r.has(p))if(i.has(p)){let h=this.compressionSvc.nToId(d);o==null?o=h:c=h}else o!=null&&(c==null?s.push(o):s.push(o+x+c),o=void 0,c=void 0)}),o!=null&&(c==null?s.push(o):s.push(o+x+c)),s.join(S)}zipDiffString(i,e,t){return i===e||i==null?"":[i,this.compressionSvc.nToId(t.indexOf(i))]}zipDiffNumber(i,e){return i===e||i==null?"":i.toString()}zipDiffRational(i,e){return i==null||e!=null&&i.eq(e)?"":i.toString()}zipDiffBool(i,e){return i===e?"":i?F:Mi}zipDiffIndices(i,e){let t=i!=null?i.length>0?i.join(x):A:"",n=e!=null?e.length>0?e.join(x):A:"";return t===n?"":t}zipDiffArray(i,e,t){let n=i!=null?i.length>0?i.join(x):A:"",r=e!=null?e.length>0?e.join(x):A:"";return n===r?"":i==null||i.length===0?n:[n,i.map(s=>this.compressionSvc.nToId(t.indexOf(s))).join(x)]}parseString(i,e){if(e!=null)return this.parseNString(i,e);if(i?.length)return i}parseBool(i){if(i?.length)return i===F}parseNumber(i){if(i?.length)return Number(i)}parseRational(i){if(i?.length)return Y(i)}parseArray(i,e){if(e)return this.parseNArray(i,e);if(i?.length)return i===A?[]:i.split(x)}parseIndices(i,e){if(i?.length)return i===A?[]:i.split(x).map(t=>Number(t)).map(t=>e[t]??{})}parseNString(i,e){let t=this.parseString(i);return t==null?t:e[this.compressionSvc.idToN(t)]}parseNArray(i,e){let t=this.parseArray(i);return t==null?t:t.map(n=>e[this.compressionSvc.idToN(n)])}parseSubset(i,e){if(!i?.length)return;if(i===A)return new Set;let t=i.split(S),n=new Set;for(let r of t){let[s,o]=r.split(x).map(d=>this.compressionSvc.idToN(d)),c=o!=null?o+1:s+1;e.slice(s,c).forEach(d=>n.add(d))}return n}set(i,e,t){return n=>(r,s,...o)=>{let c=s(e),p=s(t),d=n(c,p,...o),h,f;Array.isArray(d)?[h,f]=[...d]:h=f=d,h&&(i.bare[r]=h,i.hash[r]=f)}}get(i){return e=>(e=e.bind(this),(t,...n)=>e(i[t],...n))}};z.\u0275fac=function(e){return new(e||z)},z.\u0275prov=U({token:z,factory:z.\u0275fac,providedIn:"root"});let u=z;return u})();var g="_",Z="?",a=function(u){return u.Version="v",u.Mod="b",u.Objectives="p",u.RecipeObjectives="q",u.Items="i",u.Recipes="r",u.Machines="f",u.Modules="m",u.Beacons="e",u.Settings="s",u.Zip="z",u}(a||{}),ii=function(u){return u.ExpensiveDeprecation="The expensive setting has been removed. Please use or request an expensive data set instead.",u.LimitStepDeprecation="Limit steps have been replaced by limit objectives. Results may differ if using multiple objectives as limits apply to all objectives.",u}(ii||{}),Ui=(()=>{let z=class z{constructor(){this.analyticsSvc=R(Vi),this.compressionSvc=R(P),this.contentSvc=R(Bi),this.translateSvc=R(xi),this.zipSvc=R(J)}migrate(i,e){if(Object.keys(e).length===0)return{modId:i??_,params:{},isBare:!0};e=q(e);let t=E(e.v,I.Version0);this.analyticsSvc.event("unzip_version",t);let n=e.z==null;(n||t===I.Version0)&&Object.keys(e).forEach(o=>{Array.isArray(e[o])?e[o]=e[o].map(c=>decodeURIComponent(c)):e[o]&&(e[o]=decodeURIComponent(e[o]))});let r=this.migrateAny(i,e,n,t);return this.displayWarnings(r.warnings),["o","i","r","m","e","b"].forEach(o=>{let c=r.params[o];typeof c=="string"&&(r.params[o]=[c])}),{modId:r.modId,params:r.params,isBare:r.isBare}}migrateAny(i,e,t,n){let s={modId:i,params:e,warnings:[],isBare:t};switch(n){case I.Version0:return this.migrateV0(s);case I.Version1:return this.migrateV1(s);case I.Version2:return this.migrateV2(s);case I.Version3:return this.migrateV3(s);case I.Version4:return this.migrateV4(s);case I.Version5:return this.migrateV5(s);case I.Version6:return this.migrateV6(s);case I.Version7:return this.migrateV7(s);case I.Version8:return this.migrateV8(s);case I.Version9:return this.migrateV9(s);case I.Version10:return this.migrateV10(s);default:return s}}migrateV0(i){let{params:e}=i;if(e[a.Settings]){let n=y(e[a.Settings]).split(S),r=this.zipSvc.parseString(n[0]);r=r&&G.modHash[G.modHashV0.indexOf(r)],r=r??"";let s=this.zipSvc.parseNumber(n[6])??60,o=s===1?"0":s===3600?"2":"1";e[a.Settings]=this.zipSvc.zipFields([r,o,y(e[a.Mod]),n[1],n[3],n[4],n[5],n[7],n[8],n[10],n[9],n[2],n[11],n[12]])}else e[a.Mod]&&(e[a.Settings]=this.zipSvc.zipFields([Z,Z,y(e[a.Mod])]));return delete e[a.Mod],e[a.Version]=I.Version1,this.migrateV1(i)}migrateV1(i){let{params:e,warnings:t}=i;if(e[a.Settings]){let r=y(e[a.Settings]).split(S),s=11;if(r.length>s){let o=r.splice(s,1);this.zipSvc.parseBool(o[0])&&t.push(ii.ExpensiveDeprecation)}e[a.Settings]=this.zipSvc.zipFields(r)}return e[a.Version]=I.Version4,this.migrateV4(i)}migrateV2(i){let{params:e}=i;if(e[a.Recipes]){let n=y(e[a.Recipes]).split(g),r=[],s=3;for(let o of n){let c=o.split(S);if(c.length>s){let p=this.parseNNumber(c[s])?.toString();c[s]=this.zipSvc.zipString(p)}r.push(this.zipSvc.zipFields(c))}e[a.Recipes]=r.join(g)}if(e[a.Machines]){let n=y(e[a.Machines]).split(g),r=[],s=2;for(let o of n){let c=o.split(S);if(c.length>s){let p=this.parseNNumber(c[s])?.toString();c[s]=this.zipSvc.zipString(p)}r.push(this.zipSvc.zipFields(c))}e[a.Machines]=r.join(g)}return e[a.Version]=I.Version3,this.migrateV3(i)}migrateV3(i){let{params:e,warnings:t}=i;if(e[a.Settings]){let r=y(e[a.Settings]).split(S),s=10;if(r.length>s){let o=r.splice(s,1);this.zipSvc.parseBool(o[0])&&t.push(ii.ExpensiveDeprecation)}e[a.Settings]=this.zipSvc.zipFields(r)}return e[a.Version]=I.Version5,this.migrateV5(i)}migrateInlineBeaconsSection(i,e,t,n){if(i[e]){let s=y(i[e]).split(g),o=[];for(let c of s.map(p=>p.split(S))){let p=t+1,d=p+1,h=d+3;if(c.length>t){let f,m,M;c.length>h&&(M=c.splice(h,1)[0]),c.length>d&&(f=c.splice(d,1)[0]),c.length>p&&(m=c.splice(p,1)[0]);let l=c[t];c[t]=this.zipSvc.zipArray([n.length]),n.push(this.zipSvc.zipFields([l,this.zipSvc.zipString(m),this.zipSvc.zipString(f),this.zipSvc.zipString(M)]))}o.push(this.zipSvc.zipFields(c))}i[e]=o.join(g)}}migrateInlineBeacons(i){let e=[];return this.migrateInlineBeaconsSection(i.params,a.RecipeObjectives,4,e),this.migrateInlineBeaconsSection(i.params,a.Recipes,3,e),e.length&&(i.params[a.Beacons]=e.join(g)),i}migrateV4(i){return i=this.migrateInlineBeacons(i),i.params[a.Version]=I.Version6,this.migrateV6(i)}migrateV5(i){return i=this.migrateInlineBeacons(i),i.params[a.Version]=I.Version7,this.migrateV7(i)}migrateInsertField(i,e,t){if(i[e]){let n=y(i[e]).split(g);for(let r=0;r<n.length;r++){let s=n[r].split(S);s.length>t&&(s.splice(t,0,""),n[r]=this.zipSvc.zipFields(s))}i[e]=n.join(g)}}migrateDeleteField(i,e,t){if(i[e]){let n=y(i[e]).split(g);for(let r=0;r<n.length;r++){let s=n[r].split(S);s.length>t&&(s.splice(t,1),n[r]=this.zipSvc.zipFields(s))}i[e]=n.join(g)}}migrateMoveUpField(i,e,t){if(i[e]!=null){let n=i[e];for(i.splice(e,1),i.length>t&&i.splice(t,0,"");i.length<=t;)i.push("");i[t]=n}}migrateToV8(i){let{params:e,isBare:t}=i,n=!1;if(this.migrateInsertField(e,a.RecipeObjectives,2),e[a.Objectives]){let r=y(e[a.Objectives]).split(g),s=[...r];for(let o=0;o<r.length;o++){let p=r[o].split(S);if(p[2]==="3")if(t){let d=e[a.RecipeObjectives]?y(e[a.RecipeObjectives]).split(g):[];if(p.length>3){let h=[p[3],p[1],T.Limit.toString()],f=[p[0],"1",T.Maximize.toString()];d.push(this.zipSvc.zipFields(f)),d.push(this.zipSvc.zipFields(h)),n=!0}else d.push(this.zipSvc.zipFields([p[0],p[1]]));s.splice(o,1),e[a.RecipeObjectives]=d.join(g)}else p[2]="0",s[o]=this.zipSvc.zipFields(p);else if(p.length>3){let d=[p[3],p[1],p[2],T.Limit.toString()],h=[p[0],"1","",T.Maximize.toString()];s[o]=this.zipSvc.zipFields(h),s.push(this.zipSvc.zipFields(d)),n=!0}}n&&i.warnings.push(ii.LimitStepDeprecation),e[a.Objectives]=s.join(g)}if(this.migrateDeleteField(e,a.Items,4),this.migrateInsertField(e,a.Recipes,1),e[a.Settings]){let r=y(e[a.Settings]).split(S),s=t?1:0;if(r.length>2+s){let o=this.zipSvc.parseArray(r[2+s]);if(o){let c=y(e[a.Recipes]),p=c?c.split(g):[];for(let d of o){let h=!1;for(let f=0;f<p.length;f++){let m=p[f].split(S);m[0]===d&&(h=!0,m[1]=F,p[f]=this.zipSvc.zipFields(m))}h||p.push(this.zipSvc.zipFields([d,F]))}e[a.Recipes]=p.join(g)}r.splice(2+s,1)}r.splice(s,0,""),this.migrateMoveUpField(r,16+s,20+s),this.migrateMoveUpField(r,15+s,19+s),this.migrateMoveUpField(r,14+s,18+s),this.migrateMoveUpField(r,13+s,17+s),e[a.Settings]=this.zipSvc.zipFields(r)}return e[a.Version]=I.Version8,i}migrateV6(i){return i.isBare=!0,this.migrateV8(this.migrateToV8(i))}migrateV7(i){return i.isBare=!1,this.migrateV8(this.migrateToV8(i))}migrateV8(i){let{params:e}=i;if(e[a.RecipeObjectives]){let t=[];e[a.Objectives]&&(t=y(e[a.Objectives]).split(g));let n=y(e[a.RecipeObjectives]).split(g);for(let r of n){let s=r.split(S),o=this.zipSvc.zipFields([s[0],s[1],"3",s[2],s[3],s[4],s[5],s[6],s[7]]);t.push(o)}e[a.RecipeObjectives]="",e[a.Objectives]=t.join(g)}return this.migrateV9(i)}migrateInlineModulesSection(i,e,t,n){if(i[e]){let s=y(i[e]).split(g),o=[];for(let c of s.map(p=>p.split(S))){if(c.length>t){let p=c[t],d=this.zipSvc.parseArray(p);if(d==null)continue;let h=new Map;for(let m of d){let M=h.get(m)??0;h.set(m,M+1)}let f=Array.from(h.keys()).map((m,M)=>n.length+M);c[t]=this.zipSvc.zipArray(f);for(let m of h.keys())n.push(this.zipSvc.zipFields([E(h.get(m)?.toString(),""),m]))}o.push(this.zipSvc.zipFields(c))}i[e]=o.join(g)}}migrateV9(i){let{params:e}=i,t=[];if(this.migrateInlineModulesSection(i.params,a.Beacons,1,t),this.migrateInlineModulesSection(i.params,a.Recipes,3,t),this.migrateInlineModulesSection(i.params,a.Objectives,5,t),i.params[a.Machines]){let r=y(e[a.Machines]).split(g),s=[],o=i.params[a.Beacons]?y(i.params[a.Beacons]).split(g):[],c=2,p=c+1,d=p+1;r.map(h=>h.split(S)).forEach((h,f)=>{if(f===0&&h[0]===F&&(h[0]=A),this.migrateMoveUpField(h,5,6),h[0]!==A&&h[0]!==""&&h.length>1){let m=h[1];if(m){let M=m.split(x)[0];h[1]=this.zipSvc.zipArray([t.length]),t.push(this.zipSvc.zipFields(["",M]))}}if(h.length>2){let m,M;if(h.length>d&&(m=h.splice(d,1)[0]),h.length>p){let j=h.splice(p,1)[0];if(j){let B=j.split(x)[0];M=[t.length],t.push(this.zipSvc.zipFields(["",B]))}}let l=h[c];h[c]=this.zipSvc.zipArray([o.length]),o.push(this.zipSvc.zipFields([l,this.zipSvc.zipArray(M),this.zipSvc.zipString(m)]))}s.push(this.zipSvc.zipFields(h))}),o.length&&(i.params[a.Beacons]=o.join(g)),i.params[a.Machines]=s.join(g)}if(t.length&&(i.params[a.Modules]=t.join(g)),e[a.Settings]){let n=y(e[a.Settings]).split(S),r=i.isBare?5:4;if(n.length>r){let s=n.splice(r,1)[0];if(e[a.Machines]){let o=y(e[a.Machines]).split(g).map(p=>p.split(S)),c=o.find(p=>p[0]===A||p[0]==="");if(c){for(;c.length<4;)c.push("");c[3]=s}else o.unshift(["","","",s]);e[a.Machines]=o.map(p=>this.zipSvc.zipFields(p)).join(g)}else e[a.Machines]=["","","",s].join(S);e[a.Settings]=n.join(S)}}return e[a.Version]=I.Version10,this.migrateV10(i)}migrateV10(i){let{params:e}=i;delete e[a.RecipeObjectives];let t=new Set,n=new Set,r=new Set,s=new Set,o=new Set;function c(b,v){v.size!==0&&(e[b]=Array.from(v).join(x))}let p=e[a.Modules];delete e[a.Modules];let d=p?.split(g),h=e[a.Beacons];delete e[a.Beacons];let f=h?.split(g),m=e[a.Objectives];delete e[a.Objectives];let M=[],l=m?.split(g).map((b,v)=>{let w=b.split(S),C=v.toString();return M.push(C),w[8]===F&&t.add(C),w.splice(8,1),w.join(S)}).filter(b=>b);l?.length&&(e.o=l),t.size&&(e.och=this.zipSvc.zipDiffSubset(t,void 0,M));let j=e[a.Items];delete e[a.Items];let B=j?.split(g).map(b=>{let v=b.split(S),w=v[0];return v[1]===F&&n.add(w),v[4]===F&&r.add(w),v.splice(4,1),v.splice(1,1),v.join(S)}).filter(b=>b);B?.length&&(e.i=B),c("v10iex",n),c("v10ich",r);let k=e[a.Recipes];delete e[a.Recipes];let D=k?.split(g).map(b=>{let v=b.split(S),w=v[0];return v[1]===F&&s.add(w),v[7]===F&&o.add(w),v.splice(7,1),v.splice(1,1),v.join(S)}).filter(b=>b);D?.length&&(e.r=D),c("v10rex",s),c("v10rch",o);let Ci=e[a.Machines];delete e[a.Machines];let Q,oi,pi,ai,li,ei=[];Ci?.split(g).forEach((b,v)=>{let w=b.split(S),C=w[0];v===0?(C===A&&(Q=[]),pi=w[1],ai=w[2],oi=w[3],li=w[4]):(Q?.push(C),w.length>1&&ei.push(b))}),ei.length&&(e.m=ei),e.mmr=Q?.join(x),e.mfr=oi,e.mer=pi,e.mbe=ai,e.moc=li;let hi=e[a.Settings];if(delete e[a.Settings],hi){let b=hi.split(S),v=i.isBare?b.splice(0,1)[0]:void 0;v&&(i.modId=v);let w=b[0];w&&w!==Z&&c("v10tre",new Set(w.split(x))),["odr","mpr","ibe","ifr","bmi","bre","bic","mit","icw","ifw","ipi","mbr","mps","rnp","omt","cfa","cma","cun","cex","csu","cmx","osm","cfp"].forEach((ui,L)=>{e[ui]=b[L+1]||void 0}),i.isBare||["ifr","bmi","bre","omt"].filter(L=>e[L]!=null).forEach(L=>{e[L]=this.parseNNumber(y(e[L]))?.toString()})}let Li=e[a.Mod];delete e[a.Mod];let $=Li;$&&!i.isBare&&($=G.modHash[this.compressionSvc.idToN($)]),$&&(i.modId=$),e.e=d,e.b=f,e.v=I.Version11,N(e);function di(b){return b.replaceAll(Z,"").replaceAll(A,A)}return Object.keys(e).forEach(b=>{let v=e[b];Array.isArray(v)?e[b]=v.map(w=>di(w)):v&&(e[b]=di(v))}),i}restoreV10ResearchedTechnologies(i,e){let t=e.items.filter(c=>c.technology),n=t.map(c=>c.id);if(i==null||!n.length)return;let r=new Set(i),s=Ri(t),o;do{o=new Set;for(let c of r)s[c].technology?.prerequisites?.filter(d=>!r.has(d)).forEach(d=>o.add(d));o.forEach(c=>r.add(c))}while(o.size);if(r.size!==n.length)return r}parseNNumber(i){if(i?.length)return this.compressionSvc.idToN(i)}parseSet(i,e){if(i==null)return;let t=i.split(x);return e==null?new Set(t):new Set(t.map(n=>e[this.compressionSvc.idToN(n)]))}displayWarnings(i){this.translateSvc.multi(["app.migrationWarning","OK"]).pipe(vi()).subscribe(([e,t])=>{for(let n of i)this.contentSvc.confirm({message:n,header:e,acceptLabel:t,rejectVisible:!1})})}};z.\u0275fac=function(e){return new(e||z)},z.\u0275prov=U({token:z,factory:z.\u0275fac,providedIn:"root"});let u=z;return u})();var ke=(()=>{let z=class z{get empty(){return{bare:{},hash:{}}}get emptyRecipeSettingsInfo(){return{idMap:{},list:[]}}get emptyMachineSettings(){return{moduleMap:{},beaconMap:{}}}constructor(){this.router=R(ji),this.compressionSvc=R(P),this.dataSvc=R(Ni),this.itemsSvc=R(ki),this.machinesSvc=R(Ti),this.migrationSvc=R(Ui),this.objectivesSvc=R(Di),this.recipesSvc=R(Ei),this.settingsSvc=R(Fi),this.zipSvc=R(J),this.zipState$=new ti,this.zipConfig=si(this.empty),this.version=I.Version11,this.zipTail={v:this.version},this.route$=new ti,this.ready=si(!1),this.navigating$=new fi(!1),this.stored=Ai("router"),this.route$.pipe(W(i=>Si({params:i.params,queryParams:i.queryParams})),Ii(this.navigating$),gi(([i,e])=>!e),X(([i])=>i),W(t=>V(this,[t],function*({params:i,queryParams:e}){return e=yield this.unzipQueryParams(e),{params:i,queryParams:e}})),X(({params:i,queryParams:e})=>this.migrationSvc.migrate(i.id,e)),W(({modId:i,params:e,isBare:t})=>this.updateState(i,e,t))).subscribe(),yi(()=>{let i=this.ready(),e=this.settingsSvc.hash();if(!i||!e)return;let t=this.objectivesSvc.state(),n=this.itemsSvc.state(),r=this.recipesSvc.state(),s=this.machinesSvc.state(),o=this.settingsSvc.state(),c=this.settingsSvc.dataset();this.zipState$.next({objectives:t,items:n,recipes:r,machines:s,settings:o,data:c,hash:e})}),this.zipState$.pipe(zi(0),X(i=>this.zipState(i)),bi(i=>{this.zipConfig.set(i.config)}),W(i=>this.updateUrl(i))).subscribe()}updateUrl(i){return V(this,null,function*(){let e=yield this.getHash(i);this.navigating$.next(!0),yield this.router.navigate([],{queryParams:e}),this.navigating$.next(!1);let t=this.router.url,n=t.split("?")[0];(n.endsWith("list")||n.endsWith("flow"))&&this.stored.set(t)})}zipState(i){let{objectives:e,items:t,recipes:n,machines:r,settings:s,data:o,hash:c}=i,p=this.zipModulesBeacons(e,n,r,s,c);return this.zipObjectives(p,e,c),this.zipItems(p,t,c),this.zipRecipes(p,n,c),this.zipMachines(p,r,c),this.zipSettings(p,s,Object.keys(e),o,c),p}stepHref(i,e,t){return V(this,null,function*(){if(t==null)return null;let n;if(i.itemId!=null&&i.items!=null?n={1:{id:"1",targetId:i.itemId,value:i.items,unit:K.Items,type:T.Output}}:i.recipeId!=null&&i.machines!=null&&(n={1:{id:"1",targetId:i.recipeId,value:i.machines,unit:K.Machines,type:T.Output}}),n==null)return null;let r={objectives:this.empty,config:e,objectiveSettings:this.emptyMachineSettings,recipeSettings:this.emptyMachineSettings,machineSettings:this.emptyMachineSettings};return this.zipObjectives(r,n,t),yield this.getHash(r)})}getHash(i){return V(this,null,function*(){let e=q(i.objectives.bare,i.config.bare,this.zipTail),t=q(i.objectives.hash,i.config.hash,this.zipTail),n=this.toString(t),s={z:yield this.compressionSvc.deflate(n),v:this.version},c=this.toString(e).length,d=this.toString(s).length;return c<Math.max(d,200)?e:s})}toParams(i){let e=i.split("&");return e.some(t=>!t.includes("="))?e.reduce((t,n)=>(t[n[0]]=n.substring(1),t),{}):e.reduce((t,n)=>{let[r,s]=n.split("=");return t[r]=s,t},{})}toString(i){return Object.keys(i).flatMap(e=>{let t=i[e];return Array.isArray(t)?t.map(n=>`${e}=${n}`):t?`${e}=${t}`:[]},"").join("&")}unzipQueryParams(i){return V(this,null,function*(){let e=i.z;if(e!=null)try{let t=y(e).replace(/\+/g,"-").replace(/\//g,".").replace(/=/g,"_"),n=yield this.compressionSvc.inflate(t);i=this.toParams(n),i.z=e}catch(t){throw console.error(t),new Error("RouterService failed to parse url")}return i})}updateState(i,e,t){return V(this,null,function*(){if(i==null&&Object.keys(e).length===0){this.ready.set(!0);return}let[n,r]=yield mi(this.dataSvc.requestData(i??_)),s=t?void 0:r,o=this.unzipModules(e,s),c=this.unzipBeacons(e,o,s),p={};p.objectivesState=this.unzipObjectives(e,o,c,s),p.itemsState=this.unzipItems(e,s),p.recipesState=this.unzipRecipes(e,o,c,s),p.machinesState=this.unzipMachines(e,o,c,s);let d=p.objectivesState?Object.keys(p.objectivesState):[];p.settingsState=this.unzipSettings(i,e,c,d,n,r,s),this.dispatch(p)})}dispatch(i){this.objectivesSvc.load(i.objectivesState),this.itemsSvc.load(i.itemsState),this.recipesSvc.load(i.recipesState),this.machinesSvc.load(i.machinesState),this.settingsSvc.load(i.settingsState),this.ready.set(!0)}zipModulesBeacons(i,e,t,n,r){let s=this.emptyRecipeSettingsInfo,o=this.emptyRecipeSettingsInfo,c=j=>this.zipMachineSettings(j,s,o,r),p=c(i),d=c(e),h=c(t),f;if(n.beacons){let j=this.beaconModuleMap(n.beacons,s,r);f=this.zipBeaconArray(n.beacons,j,o,r)}let m=this.empty,M=["bare","hash"];return[["e",s.list],["b",o.list]].forEach(([j,B])=>{B.forEach(k=>{M.forEach(D=>{m[D][j]==null?m[D][j]=[k[D]]:m[D][j].push(k[D])})})}),{objectives:this.empty,config:m,objectiveSettings:p,recipeSettings:d,machineSettings:h,beacons:f}}zipMachineSettings(i,e,t,n){let r=this.emptyMachineSettings;for(let s of Object.keys(i)){let o=i[s];if(o.modules!=null&&(r.moduleMap[s]=this.zipModuleArray(o.modules,e,n)),o.beacons!=null){let c=this.beaconModuleMap(o.beacons,e,n);r.beaconMap[s]=this.zipBeaconArray(o.beacons,c,t,n)}}return r}beaconModuleMap(i,e,t){return i.map(n=>{if(n.modules!=null)return this.zipModuleArray(n.modules,e,t)})}zipModuleArray(i,e,t){return i.map(n=>{let r=this.zipSvc.zipRational(n.count),s={bare:this.zipSvc.zipFields([r,this.zipSvc.zipString(n.id)]),hash:this.zipSvc.zipFields([r,this.zipSvc.zipNString(n.id,t.modules)])};return e.idMap[s.bare]==null&&(e.idMap[s.bare]=e.list.length,e.list.push(s)),e.idMap[s.bare]})}unzipModules(i,e){return i.e==null?[]:i.e.map(t=>{let n=t.split(S),r=0,s={count:this.zipSvc.parseRational(n[r++]),id:this.zipSvc.parseString(n[r++],e?.modules)};return N(s),s})}zipBeaconArray(i,e,t,n){return i.map((r,s)=>{let o=this.zipSvc.zipRational(r.count),c=this.zipSvc.zipArray(e[s]),p=this.zipSvc.zipRational(r.total),d={bare:this.zipSvc.zipFields([o,c,this.zipSvc.zipString(r.id),p]),hash:this.zipSvc.zipFields([o,c,this.zipSvc.zipNString(r.id,n.beacons),p])};return t.idMap[d.bare]==null&&(t.idMap[d.bare]=t.list.length,t.list.push(d)),t.idMap[d.bare]})}unzipBeacons(i,e,t){return i.b==null?[]:i.b.map(n=>{let r=n.split(S),s=0,o={count:this.zipSvc.parseRational(r[s++]),modules:this.zipSvc.parseIndices(r[s++],e),id:this.zipSvc.parseString(r[s++],t?.beacons),total:this.zipSvc.parseRational(r[s++])};return N(o),o})}zipObjectives(i,e,t){let n=Object.keys(e);if(!n.length)return;let r=n.map(s=>e[s]);i.objectives.bare.o=[],i.objectives.hash.o=[];for(let s of r){let o=this.zipSvc.zipDiffRational(s.value,Y.one),c=this.zipSvc.zipDiffNumber(s.unit,K.Items),p=this.zipSvc.zipDiffNumber(s.type,T.Output),d=this.zipSvc.zipArray(i.objectiveSettings.moduleMap[s.id]),h=this.zipSvc.zipArray(i.objectiveSettings.beaconMap[s.id]),f=this.zipSvc.zipNumber(s.overclock);i.objectives.bare.o.push(this.zipSvc.zipFields([s.targetId,o,c,p,this.zipSvc.zipString(s.machineId),d,h,f,this.zipSvc.zipString(s.fuelId)])),i.objectives.hash.o.push(this.zipSvc.zipFields([this.zipSvc.zipNString(s.targetId,ri(s)?t.recipes:t.items),o,c,p,this.zipSvc.zipNString(s.machineId,t.machines),d,h,f,this.zipSvc.zipNString(s.fuelId,t.fuels)]))}}unzipObjectives(i,e,t,n){if(i.o==null)return;let r={},s=1;for(let o of i.o){let c=o.split(S),p=0,d=s.toString(),h={id:s.toString(),targetId:c[p++],value:E(this.zipSvc.parseRational(c[p++]),Y.one),unit:this.zipSvc.parseNumber(c[p++])??K.Items,type:this.zipSvc.parseNumber(c[p++])??T.Output,machineId:this.zipSvc.parseString(c[p++],n?.machines),modules:this.zipSvc.parseIndices(c[p++],e),beacons:this.zipSvc.parseIndices(c[p++],t),overclock:this.zipSvc.parseRational(c[p++]),fuelId:this.zipSvc.parseString(c[p++],n?.fuels)};n&&(h.targetId=E(this.zipSvc.parseNString(h.targetId,ri(h)?n.recipes:n.items),"")),N(h),r[d]=h,s++}return r}zipItems(i,e,t){let n=Object.keys(e);if(n.length){i.config.bare.i=[],i.config.hash.i=[];for(let r of n){let s=e[r];i.config.bare.i.push(this.zipSvc.zipFields([r,this.zipSvc.zipString(s.beltId),this.zipSvc.zipString(s.wagonId)])),i.config.hash.i.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.items),this.zipSvc.zipNString(s.beltId,t.belts),this.zipSvc.zipNString(s.wagonId,t.wagons)]))}}}unzipItems(i,e){if(i.i==null)return;let t={};for(let n of i.i){let r=n.split(S),s=0,o=E(this.zipSvc.parseString(r[s++],e?.items),""),c={beltId:this.zipSvc.parseString(r[s++],e?.belts),wagonId:this.zipSvc.parseString(r[s++],e?.wagons)};N(c),Object.keys(c).length&&(t[o]=c)}return t}zipRecipes(i,e,t){let n=Object.keys(e);if(n.length){i.config.bare.r=[],i.config.hash.r=[];for(let r of n){let s=e[r],o=this.zipSvc.zipArray(i.recipeSettings.moduleMap[r]),c=this.zipSvc.zipArray(i.recipeSettings.beaconMap[r]),p=this.zipSvc.zipNumber(s.overclock),d=this.zipSvc.zipNumber(s.cost);i.config.bare.r.push(this.zipSvc.zipFields([r,this.zipSvc.zipString(s.machineId),o,c,p,d,this.zipSvc.zipString(s.fuelId)])),i.config.hash.r.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.recipes),this.zipSvc.zipNString(s.machineId,t.machines),o,c,p,d,this.zipSvc.zipNString(s.fuelId,t.fuels)]))}}}unzipRecipes(i,e,t,n){if(i.r==null)return;let r={};for(let s of i.r){let o=s.split(S),c=0,p=E(this.zipSvc.parseString(o[c++],n?.recipes),""),d={machineId:this.zipSvc.parseString(o[c++],n?.machines),modules:this.zipSvc.parseArray(o[c++])?.map(h=>e[Number(h)]??{}),beacons:this.zipSvc.parseArray(o[c++])?.map(h=>t[Number(h)]??{}),overclock:this.zipSvc.parseRational(o[c++]),cost:this.zipSvc.parseRational(o[c++]),fuelId:this.zipSvc.parseString(o[c++],n?.fuels)};N(d),Object.keys(d).length&&(r[p]=d)}return r}zipMachines(i,e,t){let n=Object.keys(e);if(n.length){i.config.bare.m=[],i.config.hash.m=[];for(let r of n){let s=e[r],o=this.zipSvc.zipArray(i.machineSettings.moduleMap[r]),c=this.zipSvc.zipArray(i.machineSettings.beaconMap[r]),p=this.zipSvc.zipNumber(s.overclock);i.config.bare.m.push(this.zipSvc.zipFields([r,o,c,this.zipSvc.zipString(s.fuelId),p])),i.config.hash.m.push(this.zipSvc.zipFields([this.zipSvc.zipNString(r,t.machines),o,c,this.zipSvc.zipNString(s.fuelId,t.fuels),p]))}}}unzipMachines(i,e,t,n){if(i.m==null)return;let r={};for(let s of i.m){let o=s.split(S),c=0,p=E(this.zipSvc.parseString(o[c++],n?.machines),""),d={modules:this.zipSvc.parseArray(o[c++])?.map(h=>e[Number(h)]??{}),beacons:this.zipSvc.parseArray(o[c++])?.map(h=>t[Number(h)]??{}),fuelId:this.zipSvc.parseString(o[c++],n?.fuels),overclock:this.zipSvc.parseRational(o[c++])};N(d),Object.keys(d).length&&(r[p]=d)}return r}zipSettings(i,e,t,n,r){let s=Oi,o=this.zipSvc.set(i.config,e,s),c=o(this.zipSvc.zipDiffSubset.bind(this.zipSvc)),p=o(this.zipSvc.zipDiffNumber.bind(this.zipSvc)),d=o(this.zipSvc.zipDiffBool.bind(this.zipSvc)),h=o(this.zipSvc.zipDiffString.bind(this.zipSvc)),f=o(this.zipSvc.zipDiffRational.bind(this.zipSvc)),m=o(this.zipSvc.zipDiffArray.bind(this.zipSvc)),M=o(this.zipSvc.zipDiffIndices.bind(this.zipSvc));c("och",l=>l.checkedObjectiveIds,t),p("omt",l=>l.maximizeType),d("osm",l=>l.surplusMachinesOutput),p("odr",l=>l.displayRate),c("iex",l=>l.excludedItemIds,n.itemIds,r.items),c("ich",l=>l.checkedItemIds,n.itemIds,r.items),h("ibe",l=>l.beltId,r.belts),h("ipi",l=>l.pipeId,r.belts),h("icw",l=>l.cargoWagonId,r.wagons),h("ifw",l=>l.fluidWagonId,r.wagons),f("ifr",l=>l.flowRate),c("rex",l=>l.excludedRecipeIds,n.recipeIds,r.recipes),c("rch",l=>l.checkedRecipeIds,n.recipeIds,r.recipes),d("rnp",l=>l.netProductionOnly),p("mpr",l=>l.preset),m("mmr",l=>l.machineRankIds,r.machines),m("mfr",l=>l.fuelRankIds,r.fuels),m("mer",l=>l.moduleRankIds,r.modules),M("mbe",l=>l===s?void 0:i.beacons),f("moc",l=>l.overclock),f("mbr",l=>l.beaconReceivers),h("mps",l=>l.proliferatorSprayId,r.modules),p("mit",l=>l.inserterTarget),f("bmi",l=>l.miningBonus),f("bre",l=>l.researchBonus),p("bic",l=>l.inserterCapacity),c("tre",l=>l.researchedTechnologyIds,n.technologyIds,r.technologies),f("cfa",l=>l.costs.factor),f("cma",l=>l.costs.machine),f("cfp",l=>l.costs.footprint),f("cun",l=>l.costs.unproduceable),f("cex",l=>l.costs.excluded),f("csu",l=>l.costs.surplus),f("cmx",l=>l.costs.maximize)}unzipSettings(i,e,t,n,r,s,o){let c=this.zipSvc.get(e),p=c(this.zipSvc.parseSubset.bind(this.zipSvc)),d=c(this.zipSvc.parseNumber.bind(this.zipSvc)),h=c(this.zipSvc.parseBool.bind(this.zipSvc)),f=c(this.zipSvc.parseString.bind(this.zipSvc)),m=c(this.zipSvc.parseRational.bind(this.zipSvc)),M=c(this.zipSvc.parseArray.bind(this.zipSvc)),l=c(this.zipSvc.parseIndices.bind(this.zipSvc)),j={modId:i,checkedObjectiveIds:p("och",n),maximizeType:d("omt"),surplusMachinesOutput:h("osm"),displayRate:d("odr"),excludedItemIds:p("iex",s.items),checkedItemIds:p("ich",s.items),beltId:f("ibe",o?.belts),pipeId:f("ipi",o?.belts),cargoWagonId:f("icw",o?.wagons),fluidWagonId:f("ifw",o?.wagons),flowRate:m("ifr"),excludedRecipeIds:p("rex",s.recipes),checkedRecipeIds:p("rch",s.recipes),netProductionOnly:h("rnp"),preset:d("mpr"),machineRankIds:M("mmr",o?.machines),fuelRankIds:M("mfr",o?.fuels),moduleRankIds:M("mer",o?.modules),beacons:l("mbe",t),overclock:m("moc"),beaconReceivers:m("mbr"),proliferatorSprayId:f("mps",o?.modules),inserterTarget:d("mit"),miningBonus:m("bmi"),researchBonus:m("bre"),inserterCapacity:d("bic"),researchedTechnologyIds:p("tre",s.technologies)},B={factor:m("cfa"),machine:m("cma"),footprint:m("cfp"),unproduceable:m("cun"),excluded:m("cex"),surplus:m("csu"),maximize:m("cmx")},k=this.migrationSvc.parseSet.bind(this.migrationSvc);if(e.v10iex&&(j.excludedItemIds=k(e.v10iex,o?.items)),e.v10ich&&(j.checkedItemIds=k(e.v10ich,o?.items)),e.v10rex&&(j.excludedRecipeIds=k(e.v10rex,o?.recipes)),e.v10rch&&(j.checkedRecipeIds=k(e.v10rch,o?.recipes)),e.v10tre&&(j.researchedTechnologyIds=k(e.v10tre,o?.technologies),j.researchedTechnologyIds=this.migrationSvc.restoreV10ResearchedTechnologies(j.researchedTechnologyIds,r)),N(B),Object.keys(B).length&&(j.costs=B),N(j),!!Object.keys(j).length)return j}};z.\u0275fac=function(e){return new(e||z)},z.\u0275prov=U({token:z,factory:z.\u0275fac,providedIn:"root"});let u=z;return u})();export{Ui as a,ke as b};
